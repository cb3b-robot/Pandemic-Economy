<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Pandemic City — Isometric + Primer Blobs (Polish + Needs Fix)</title>
<style>
  :root { --w: 900px; --h: 560px; }
  *{box-sizing:border-box}
  body{margin:0;background:#0c0f16;color:#eef3ff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;display:flex;flex-direction:column;align-items:center;gap:10px;padding:10px}
  h1{margin:8px 0 4px;font-size:clamp(18px,3.2vw,28px);letter-spacing:.2px}
  #top{display:flex;flex-wrap:wrap;gap:8px;align-items:center;justify-content:center;background:#141a2a;border:1px solid #223152;border-radius:12px;padding:8px 12px}
  .pill{padding:6px 10px;background:#0f1526;border:1px solid #203259;border-radius:10px}
  .accent{color:#9bd6ff}.ok{color:#8cf0a7}.bad{color:#ff8b8b}
  #wrap{display:grid;grid-template-columns: 1fr 1fr;gap:10px;width:min(1200px,98vw)}
  #left,#right{background:#12182a;border:1px solid #223152;border-radius:12px;padding:10px}
  #game{width:var(--w);height:var(--h);background:#0e1423;border:1px solid #23314f;border-radius:10px;display:block;margin:auto}
  #hover{font-size:12px;opacity:.9;margin-top:4px}
  #controls{display:flex;flex-wrap:wrap;gap:8px}
  button,label{background:#182444;color:#e8f0ff;border:1px solid #2a4070;border-radius:10px;padding:7px 10px;font-size:14px}
  button:hover{filter:brightness(1.08);cursor:pointer}
  #visits{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
  .slot{background:#0f1426;border:1px solid #2a4070;padding:8px;border-radius:10px;min-width:240px}
  #pane{margin-top:8px}
  #log{height:170px;overflow:auto;background:#0f1422;border:1px solid #243458;border-radius:10px;padding:8px;font-size:12px}
</style>
</head>
<body>
<h1>Pandemic City — Isometric + Primer Blobs</h1>

<div id="top">
  <div class="pill">Day: <span id="day" class="accent">1</span></div>
  <div class="pill">Phase: <span id="phase" class="accent">Planning</span></div>
  <div class="pill">Visits: <span id="visitsLeft" class="accent">2</span> / <span id="visitsMax" class="accent">2</span></div>
  <div class="pill">Money: $<span id="money" class="accent">200</span></div>
  <div class="pill">Status: <span id="status" class="accent ok">Healthy</span></div>
  <div class="pill">Needs: Food <span id="nf" class="ok">OK</span> · Fun <span id="ne" class="ok">OK</span></div>
  <div class="pill">House Lv: <span id="houseLv" class="accent">1</span> <button id="expandBtn">Expand ($150)</button></div>
</div>

<div id="wrap">
  <div id="left">
    <canvas id="game" width="900" height="560"></canvas>
    <div id="hover"></div>
  </div>

  <div id="right">
    <div id="controls">
      <button id="clearBtn">Clear Visits</button>
      <button id="startBtn">Start Day</button>
      <button id="fastBtn">Fast</button>
      <button id="skipBtn">Skip</button>
    </div>
    <div id="visits">
      <div class="slot">
        <div><strong>Visit 1:</strong> <span id="v1">— (click a business)</span></div>
        <label><input type="checkbox" id="w1"> Work this visit</label>
      </div>
      <div class="slot">
        <div><strong>Visit 2:</strong> <span id="v2">— (click a business)</span></div>
        <label><input type="checkbox" id="w2"> Work this visit</label>
      </div>
    </div>
    <div id="pane"></div>
    <h3 style="margin:10px 0 6px;">City Log</h3>
    <div id="log"></div>
  </div>
</div>

<script>
/* =========================
   ISOMETRIC SETTINGS
========================= */
const W=900,H=560;
const GRID_COLS=28, GRID_ROWS=18;
const TILE_W=44, TILE_H=22;           // diamond
const ELEV=18;                        // building wall height
const ORIGIN_X=W/2, ORIGIN_Y=88;      // base origin

function isoToScreen(col,row,z=0){
  const x = (col - row) * (TILE_W/2);
  const y = (col + row) * (TILE_H/2) - z;
  return {x: ORIGIN_X + x, y: ORIGIN_Y + y};
}
function screenToIso(sx,sy){
  sx -= ORIGIN_X; sy -= ORIGIN_Y;
  const col = Math.floor((sy / (TILE_H/2) + sx / (TILE_W/2)) / 2);
  const row = Math.floor((sy / (TILE_H/2) - sx / (TILE_W/2)) / 2);
  return {col,row};
}

/* =========================
   GAME CONSTANTS
========================= */
const PHASE_MS = 11000;
const INF_BASE = 0.01;
const INF_RAD  = 16;
const SICK_DAYS= 7;
const POP      = 70;
const HOUSES   = 45;
const SHOPS    = 26;
const SPEEDS   = {normal:1,fast:4,skip:999};

const PRODUCTS=[
  {id:"food",name:"Food",base:10, need:"food"},
  {id:"med",name:"Medicine",base:26},
  {id:"coffee",name:"Coffee",base:6, need:"fun"},
  {id:"book",name:"Book",base:15, need:"fun"},
  {id:"toy",name:"Toy",base:12, need:"fun"},
  {id:"shirt",name:"Shirt",base:30},
  {id:"gadget",name:"Gadget",base:85},
];
const CATALOG=[
  {type:"Grocery", offers:["food"]},
  {type:"Pharmacy", offers:["med"]},
  {type:"Cafe", offers:["coffee"]},
  {type:"Bookstore", offers:["book"]},
  {type:"Toy Shop", offers:["toy"]},
  {type:"Clothing", offers:["shirt"]},
  {type:"Electronics", offers:["gadget"]},
  {type:"Market", offers:["food","coffee","toy"]},
  {type:"Outlet", offers:["shirt","gadget"]},
];

/* =========================
   STATE
========================= */
const cvs=document.getElementById('game'), ctx=cvs.getContext('2d');
const dayEl=gid('day'), phaseEl=gid('phase'), visitsLeftEl=gid('visitsLeft'), visitsMaxEl=gid('visitsMax');
const moneyEl=gid('money'), statusEl=gid('status'), hoverEl=gid('hover'), pane=gid('pane');
const v1El=gid('v1'), v2El=gid('v2'), w1El=gid('w1'), w2El=gid('w2'), logEl=gid('log');
const houseLvEl=gid('houseLv'), nfEl=gid('nf'), neEl=gid('ne');

let day=1, phase="Planning", speed=SPEEDS.normal;
let visitsMax=2, visitsLeft=2, running=false, tPhase=0, lastTs=0;

const buildings=[];
const citizens=[];
const taken = new Set();

const player={
  col:0,row:0, x:0,y:0, vx:0,vy:0, target:null, home:null,
  sick:false,sickDays:0, money:200,
  priceIdeal:{}, inventory:{}, dest:[null,null], work:[false,false],
  needs:{foodOk:true, funOk:true, grumpy:false}, houseLv:1
};

function gid(id){return document.getElementById(id)}
const rint=(a,b)=>Math.floor(Math.random()*(b-a+1))+a;
const rand=(a,b)=>Math.random()*(b-a)+a;
const choice=a=>a[rint(0,a.length-1)];
const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
function product(pid){return PRODUCTS.find(p=>p.id===pid)}
function log(s){const d=document.createElement('div'); d.textContent=s; logEl.prepend(d)}

/* =========================
   CITY GENERATION
========================= */
function free(c,r){ if(c<1||r<1||c>GRID_COLS-2||r>GRID_ROWS-2) return false; return !taken.has(c+','+r) }
function occupy(c,r){taken.add(c+','+r)}
function place(kind, info={}){
  for(let t=0;t<500;t++){
    const c=rint(1,GRID_COLS-2), r=rint(1,GRID_ROWS-2);
    if(!free(c,r)) continue;
    occupy(c,r);
    const id=buildings.length;
    const b={id, kind, col:c, row:r, name: kind==='house' ? 'House '+id : info.name};
    if(kind==='biz'){
      b.type=info.type; b.owner=-1; b.hired=false; b.till=0; b.stock={}; b.sellerIdeal={};
      for(const pid of info.offers){
        b.stock[pid]=rint(6,14);
        b.sellerIdeal[pid]=+(product(pid).base*rand(1.15,1.75)).toFixed(2);
      }
    }
    buildings.push(b); return b;
  }
  return null;
}
function genCity(){
  for(let i=0;i<HOUSES;i++) place('house');
  for(let i=0;i<SHOPS;i++){ const d=choice(CATALOG); place('biz',{type:d.type,name:`${d.type} #${i+1}`,offers:d.offers}) }
  // citizens
  const houseIds=buildings.filter(b=>b.kind==='house').map(b=>b.id);
  for(let i=0;i<POP;i++){
    const h=choice(houseIds), bh=buildings[h];
    const {x,y}=isoToScreen(bh.col,bh.row);
    const c={id:i, col:bh.col,row:bh.row, x,y, vx:0,vy:0, target:null, home:h,
      sick:Math.random()<0.07, sickDays:rint(0,SICK_DAYS), wallet:rint(50,180), priceIdeal:{}};
    for(const pr of PRODUCTS){ c.priceIdeal[pr.id]=+(pr.base*rand(0.75,1.1)).toFixed(2) }
    citizens.push(c);
  }
  // player
  const ph=choice(houseIds), home=buildings[ph]; player.home=ph; player.col=home.col; player.row=home.row;
  const ps=isoToScreen(home.col,home.row); player.x=ps.x; player.y=ps.y;
  for(const pr of PRODUCTS){ player.priceIdeal[pr.id]=+(pr.base*rand(0.85,1.1)).toFixed(2) }
}
genCity();

/* =========================
   ISOMETRIC RENDER (polish)
========================= */
function drawGround(){
  // roads every 4 tiles (simple cross-grid), sidewalks, and grass diamonds
  for(let r=0;r<GRID_ROWS;r++){
    for(let c=0;c<GRID_COLS;c++){
      const p=isoToScreen(c,r);
      const onRoad = (c%4===0)||(r%4===0);
      if(onRoad){
        // road base
        drawDiamond(p.x,p.y,TILE_W,TILE_H,"#1a1f2a");
        // road center line every other block
        if(c%4===0 && r%2===0){
          ctx.strokeStyle="#2b3342"; ctx.beginPath();
          ctx.moveTo(p.x, p.y - TILE_H/2 + 3);
          ctx.lineTo(p.x + TILE_W/2 - 3, p.y);
          ctx.stroke();
        }
      } else {
        // grass with checker tint
        const dark=((c+r)&1)===0;
        drawDiamond(p.x,p.y,TILE_W,TILE_H, dark? "#0f1831":"#101a36");
      }
    }
  }
}
function drawDiamond(cx,cy,w,h,fill){
  ctx.beginPath();
  ctx.moveTo(cx, cy-h/2);
  ctx.lineTo(cx+w/2, cy);
  ctx.lineTo(cx, cy+h/2);
  ctx.lineTo(cx-w/2, cy);
  ctx.closePath();
  ctx.fillStyle=fill;
  ctx.fill();
}
function drawRoofTop(x,y,w,h,z,topColor){
  // beveled top with highlight
  ctx.beginPath();
  ctx.moveTo(x, y - h/2 - z);
  ctx.lineTo(x + w/2, y - z);
  ctx.lineTo(x, y + h/2 - z);
  ctx.lineTo(x - w/2, y - z);
  ctx.closePath();
  const g=ctx.createLinearGradient(x-w/2, y-h/2-z, x+w/2, y+h/2-z);
  g.addColorStop(0, topColor);
  g.addColorStop(1, shade(topColor, -0.1));
  ctx.fillStyle=g; ctx.fill();

  // roof highlight rim
  ctx.strokeStyle=shade(topColor, 0.25); ctx.lineWidth=1;
  ctx.stroke();
}
function drawSideFaces(x,y,w,h,z,leftColor,rightColor){
  // right
  ctx.beginPath();
  ctx.moveTo(x + w/2, y - z);
  ctx.lineTo(x + w/2, y);
  ctx.lineTo(x, y + h/2);
  ctx.lineTo(x, y + h/2 - z);
  ctx.closePath();
  ctx.fillStyle=rightColor; ctx.fill();

  // left
  ctx.beginPath();
  ctx.moveTo(x - w/2, y - z);
  ctx.lineTo(x - w/2, y);
  ctx.lineTo(x, y + h/2);
  ctx.lineTo(x, y + h/2 - z);
  ctx.closePath();
  ctx.fillStyle=leftColor; ctx.fill();

  // tiny window dots on faces
  ctx.fillStyle="#b8c9e6";
  for(let i=0;i<2;i++){
    // right face windows
    ctx.fillRect(x + w/2 - 6, y - z + 6 + i*10, 2, 2);
    // left face windows
    ctx.fillRect(x - w/2 + 4, y - z + 9 + i*10, 2, 2);
  }
}
function drawBusiness(b){
  const p=isoToScreen(b.col,b.row);
  // base sidewalk tile
  drawDiamond(p.x,p.y,TILE_W,TILE_H,"#152341");

  // color palette per type (Primer-ish blues with subtle variation)
  const baseHue = ({
    "Grocery": 200, "Market": 205, "Pharmacy": 210, "Cafe": 215, "Bookstore": 220,
    "Toy Shop": 225, "Clothing": 230, "Electronics": 235, "Outlet": 240
  }[b.type] ?? 210);
  const top = hsl(baseHue, 45, 46);
  const left= hsl(baseHue, 52, 35);
  const right=hsl(baseHue, 40, 39);

  drawSideFaces(p.x,p.y,TILE_W,TILE_H,ELEV,left,right);
  drawRoofTop  (p.x,p.y,TILE_W,TILE_H,ELEV,top);

  // label hovering just above roof
  ctx.fillStyle="#deebff"; ctx.font="11px system-ui"; ctx.textAlign="center";
  ctx.fillText(b.type.split(' ')[0], p.x, p.y - ELEV - 12);

  // ownership rim (gold)
  if(b.owner===0){
    ctx.strokeStyle="#ffd66b"; ctx.lineWidth=1.5;
    ctx.strokeRect(p.x - TILE_W/2 + 4, p.y - ELEV - TILE_H/2 + 4, TILE_W - 8, TILE_H - 8);
  }
}
function drawHouse(h){
  const p=isoToScreen(h.col,h.row);
  drawDiamond(p.x,p.y,TILE_W,TILE_H,"#121d3b");
  const z = ELEV*0.7;
  const top = hsl(215, 35, 40);
  const left= hsl(215, 40, 30);
  const right=hsl(215, 36, 34);
  drawSideFaces(p.x,p.y,TILE_W,TILE_H,z,left,right);
  drawRoofTop  (p.x,p.y,TILE_W,TILE_H,z, top);

  if(h.id===player.home){
    ctx.strokeStyle="#6be6ff"; ctx.lineWidth=1.2;
    ctx.strokeRect(p.x - TILE_W/2 + 3, p.y - z - TILE_H/2 + 3, TILE_W - 6, TILE_H - 6);
  }
}
function drawBlob(x,y,r,body){
  // soft shadow
  ctx.globalAlpha=0.35;
  ctx.beginPath(); ctx.ellipse(x, y+6, r*1.2, r*0.55, 0, 0, Math.PI*2); ctx.fillStyle="#000"; ctx.fill();
  ctx.globalAlpha=1;
  const g=ctx.createRadialGradient(x-r*0.4,y-r*0.5, r*0.3, x,y,r);
  g.addColorStop(0, "#ffffff");
  g.addColorStop(0.12, body);
  g.addColorStop(1, body);
  ctx.fillStyle=g; ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill();
}

function render(){
  ctx.clearRect(0,0,W,H);
  drawGround();
  const sorted = [...buildings].sort((a,b)=>(a.row+a.col)-(b.row+b.col));
  for(const b of sorted){
    if(b.kind==='house') drawHouse(b); else drawBusiness(b);
  }
  for(const c of citizens){ drawBlob(c.x, c.y - 10, 6, c.sick ? "#ff6c6c" : "#65e2ff"); }
  drawBlob(player.x, player.y - 12, 8, player.sick ? "#ffb36b" : "#ffe36b");
}
function hsl(h,s,l){ return `hsl(${h} ${s}% ${l}%)` }
function shade(hexOrHsl, amt){ // quick luminance tweak for HSL strings only
  // expects "hsl(h s% l%)"
  const m = /hsl\(([\d.]+)\s+([\d.]+)%\s+([\d.]+)%\)/.exec(hexOrHsl);
  if(!m) return hexOrHsl;
  const h=+m[1], s=+m[2], l=clamp(+m[3] + amt*100, 0, 100);
  return `hsl(${h} ${s}% ${l}%)`;
}

/* =========================
   INPUT (iso picking)
========================= */
cvs.addEventListener('mousemove', e=>{
  const r=cvs.getBoundingClientRect(), x=e.clientX-r.left, y=e.clientY-r.top;
  const iso=screenToIso(x,y); const b=buildingAt(iso.col,iso.row);
  if(!b){ hoverEl.textContent=""; return }
  if(b.kind==='house'){ hoverEl.textContent=`${b.name} (House)`; return }
  const offers=Object.keys(b.stock).map(pid=>{
    const inv=b.stock[pid], ask=b.sellerIdeal[pid].toFixed(2);
    return `${product(pid).name}: inv ${inv}, ask ~$${ask}`;
  }).join(" · ");
  const own = b.owner===-1? "Unowned" : (b.owner===0? "Owned by You":"Owned");
  hoverEl.textContent = `${b.name} (${b.type}) — ${offers} — ${own}${b.hired?' · Worker hired':''}`;
});
cvs.addEventListener('click', e=>{
  if(phase!=='Planning') return;
  const r=cvs.getBoundingClientRect(), x=e.clientX-r.left, y=e.clientY-r.top;
  const iso=screenToIso(x,y); const b=buildingAt(iso.col,iso.row);
  if(!b || b.kind!=='biz') return;

  const slot = player.dest[0]==null?0:(player.dest[1]==null?1:-1);
  if(slot===-1){ log('Both visits selected. Use Clear Visits to change.'); return }
  player.dest[slot]=b.id; (slot? v2El:v1El).textContent=`${b.name} (${b.type})`;
  visitsLeft = visitsMax - (player.dest.filter(v=>v!=null).length); visitsLeftEl.textContent=visitsLeft;
  pane.innerHTML = renderBizPane(b, slot); bindBizPane(b, slot);
});
function buildingAt(col,row){ return buildings.find(b=>b.col===col && b.row===row) }

/* =========================
   CONTROLS
========================= */
gid('clearBtn').onclick=()=>{
  player.dest=[null,null]; v1El.textContent='— (click a business)'; v2El.textContent='— (click a business)';
  visitsLeft=visitsMax; visitsLeftEl.textContent=visitsLeft; pane.innerHTML='';
};
gid('startBtn').onclick=startDay;
gid('fastBtn').onclick=()=>{ speed=(speed===SPEEDS.fast?SPEEDS.normal:SPEEDS.fast); log(`Speed: ${speed===SPEEDS.fast?'Fast':'Normal'}`) }
gid('skipBtn').onclick=()=>{ speed=SPEEDS.skip; log('Skipping…') }
gid('expandBtn').onclick=()=>{
  const cost = 150 + (player.houseLv-1)*100;
  if(player.money < cost){ log('Not enough money to expand house.'); return }
  player.money -= cost; player.houseLv++; updateTop();
  log(`House expanded to Lv ${player.houseLv}. Infection risk slightly reduced and negotiation improved.`);
};

/* =========================
   DAY / PHASE FLOW
========================= */
function startDay(){
  if(running) return;

  // NEW: needs indicators reflect inventory BEFORE planning
  refreshNeedsFromInventory();

  visitsMax = (player.needs.foodOk && player.needs.funOk) ? 2 : 1;
  visitsLeft = visitsMax; visitsMaxEl.textContent=visitsMax; visitsLeftEl.textContent=visitsLeft;

  if(player.sick){
    player.dest=[player.home, player.home]; v1El.textContent='(Sick) Stay Home'; v2El.textContent='(Sick) Stay Home';
    w1El.checked=false; w2El.checked=false; player.work=[false,false];
  } else {
    for(let i=0;i<visitsMax;i++) if(player.dest[i]==null){
      const ids=buildings.filter(b=>b.kind==='biz').map(b=>b.id);
      const id=choice(ids); player.dest[i]=id; (i? v2El:v1El).textContent=buildings[id].name;
    }
    if(visitsMax===1){ player.dest[1]=null; v2El.textContent='— (locked; meet your needs)'; w2El.checked=false }
    player.work=[!!w1El.checked, !!w2El.checked && visitsMax===2];
  }

  // citizens plan
  for(const a of citizens){
    if(a.sick){ a.plan=[a.home,a.home] }
    else{ const ids=buildings.filter(b=>b.kind==='biz').map(b=>b.id); a.plan=[choice(ids),choice(ids)] }
  }

  tPhase=0; lastTs=0; speed=SPEEDS.normal; phase='Visit 1'; phaseEl.textContent=phase; running=true;
  prepPhase(0); log(`Day ${day} started.`);
}
function prepPhase(k){
  aimTo(player, pointOf(player, k));
  citizens.forEach(a=>aimTo(a, pointOf(a, k)));
  const destId=player.dest[k]; pane.innerHTML='';
  if(destId!=null){ const b=buildings[destId]; if(b.kind==='biz'){ pane.innerHTML=renderShopPane(b,k); bindShopButtons(b,k) } }
}
function pointOf(agent,k){
  const id=(agent===player? player.dest[k] : agent.plan[k]);
  const target = (id==null) ? buildings[player.home] : buildings[id];
  return isoToScreen(target.col,target.row);
}
function aimTo(agent, pt){
  const dx=pt.x-agent.x, dy=pt.y-agent.y, steps=(PHASE_MS/16.7);
  agent.vx=dx/steps; agent.vy=dy/steps; agent.target=pt;
}

/* =========================
   ECONOMY + OWNERSHIP
========================= */
function midPrice(buyerIdeal,sellerIdeal,edge=0){
  const p=(buyerIdeal+sellerIdeal)/2;
  return Math.round(p - edge*(sellerIdeal-buyerIdeal));
}
function negotiationEdge(){
  let edge = 0.03 + (player.houseLv-1)*0.02;
  if(player.needs.grumpy) edge -= 0.02;
  return clamp(edge, 0, 0.15);
}
function bizCost(b){
  let val=0; for(const pid of Object.keys(b.stock)){ val += b.stock[pid]*product(pid).base }
  return Math.max(120, Math.round(val*1.8));
}
function renderBizPane(b,slot){
  const own = b.owner===0;
  const buyCost=bizCost(b);
  const hireRow = own ? `<div>Worker: <strong>${b.hired?'Hired':'None'}</strong> <button id="hireBtn">${b.hired?'Fire (no cost)':'Hire ($20/day)'}</button></div>` : '';
  return `
  <div class="slot">
    <div><strong>${b.name}</strong> — ${b.owner===-1?'Unowned':(own?'Owned by You':'Owned')}</div>
    ${!own && b.owner===-1 ? `<button id="buyBtn">Buy ($${buyCost})</button>` : ''}
    ${hireRow}
    <div style="margin-top:6px"><em>Stock & midpoint:</em></div>
    <ul style="list-style:none;padding-left:14px;text-align:left">
      ${Object.keys(b.stock).map(pid=>{
        const p=product(pid), you=player.priceIdeal[pid], ask=b.sellerIdeal[pid], edge=negotiationEdge();
        const price=midPrice(you,ask,edge);
        return `<li>${p.name}: inv <strong>${b.stock[pid]}</strong> · you $${you.toFixed(2)} · seller $${ask.toFixed(2)} → <strong>$${price}</strong></li>`
      }).join('') || '<li>Sold out.</li>'}
  </div>`;
}
function bindBizPane(b,slot){
  const buy=gid('buyBtn'); if(buy){ buy.onclick=()=>{ const cost=bizCost(b); if(player.money<cost){log('Not enough money.');return} player.money-=cost; b.owner=0; updateTop(); log(`You bought ${b.name}.`); pane.innerHTML=renderBizPane(b,slot); bindBizPane(b,slot)} }
  const hire=gid('hireBtn'); if(hire){ hire.onclick=()=>{ b.hired=!b.hired; log(`${b.hired?'Hired':'Fired'} worker at ${b.name}.`); pane.innerHTML=renderBizPane(b,slot); bindBizPane(b,slot)} }
}
function renderShopPane(b,k){
  const working = !!player.work[k];
  return `
  <div class="slot">
    <div><strong>At ${b.name}</strong> ${b.owner===0?'· Your business':''} ${working? '· Working' : '· Browsing'}</div>
    <div style="margin:6px 0">Money: $${Math.floor(player.money)} · Inventory: ${invString()} · Needs: ${needsString()}</div>
    <ul style="list-style:none;padding-left:14px;text-align:left">
      ${Object.keys(b.stock).map(pid=>{
        const p=product(pid), you=player.priceIdeal[pid], ask=b.sellerIdeal[pid], edge=negotiationEdge();
        const price=midPrice(you,ask,edge);
        return `<li>${p.name}: inv <strong>${b.stock[pid]}</strong> · you $${you.toFixed(2)} · seller $${ask.toFixed(2)} → <strong>$${price}</strong> <button data-buy="${pid}" ${b.stock[pid]<=0?'disabled':''}>Buy</button></li>`
      }).join('') || '<li>Sold out.</li>'}
    <div style="font-size:12px;opacity:.85;margin-top:4px">Buying Food or a Fun item updates your needs instantly.</div>
  </div>`;
}
function bindShopButtons(b,k){
  pane.querySelectorAll('button[data-buy]').forEach(btn=>{
    btn.onclick=()=>{
      const pid=btn.getAttribute('data-buy');
      if(b.stock[pid]<=0){ log('Out of stock.'); return }
      const p=product(pid), you=player.priceIdeal[pid], ask=b.sellerIdeal[pid], edge=negotiationEdge();
      const price=midPrice(you,ask,edge);
      if(player.money<price){ log(`Not enough money for ${p.name} ($${price}).`); return }
      player.money-=price; player.inventory[pid]=(player.inventory[pid]||0)+1; b.stock[pid]--; b.till+=price;
      if(player.work[k]){ player.money+=price } // working → earn your sale
      if(b.stock[pid]<=1) b.sellerIdeal[pid]*=1.02;
      // NEW: update needs immediately after purchase
      refreshNeedsFromInventory();
      updateTop();
      pane.innerHTML=renderShopPane(b,k); bindShopButtons(b,k);
      log(`You bought ${p.name} @ ${b.name} for $${price}.`);
    };
  });
}
function invString(){
  const keys=Object.keys(player.inventory).filter(k=>player.inventory[k]>0);
  if(keys.length===0) return '(empty)';
  return keys.map(k=>`${product(k).name}×${player.inventory[k]}`).join(', ');
}
function needsString(){
  return `Food: ${player.needs.foodOk?'OK':'NEEDED'} · Fun: ${player.needs.funOk?'OK':'NEEDED'}`;
}

/* =========================
   NEEDS (IMMEDIATE UPDATE)
========================= */
// Treat needs as “I have at least one in inventory” for the day.
// We still CONSUME items at end-of-day, but badges now reflect availability *right now*.
function hasFood(){ return (player.inventory.food||0) > 0 }
function hasFun(){ return (player.inventory.book||0)>0 || (player.inventory.toy||0)>0 || (player.inventory.coffee||0)>0 }
function refreshNeedsFromInventory(){
  player.needs.foodOk = hasFood();
  player.needs.funOk  = hasFun();
  player.needs.grumpy = !(player.needs.foodOk && player.needs.funOk);
  nfEl.className = player.needs.foodOk ? 'ok' : 'bad';
  neEl.className = player.needs.funOk  ? 'ok' : 'bad';
  nfEl.textContent = player.needs.foodOk ? 'OK' : 'NEEDED';
  neEl.textContent = player.needs.funOk  ? 'OK' : 'NEEDED';
}

/* =========================
   INFECTION & SIM
========================= */
function infectionMultiplier(){ return Math.max(0.5, 1 - 0.08*(player.houseLv-1)) }

function step(ts){
  if(!running){ render(); requestAnimationFrame(step); return }
  if(!lastTs) lastTs=ts;
  let dt=(ts-lastTs)/1000; lastTs=ts; dt*=speed;

  moveAgent(player,dt);
  citizens.forEach(a=>moveAgent(a,dt));

  infCheck(player, citizens, dt);
  citizens.forEach(c=>infCheck(c, [player,...citizens], dt));

  const k = (phase==='Visit 1'?0:(phase==='Visit 2'?1:null));
  if(k!=null){
    simulateWorkerSales(k);
    citizens.forEach(a=>maybeBuyWhenArrive(a,k,false));
    maybeBuyWhenArrive(player,k,!!player.work[k]);
  }

  tPhase += dt*1000;
  if(tPhase>=PHASE_MS || speed===SPEEDS.skip){
    for(const b of buildings) if(b.kind==='biz') for(const pid of Object.keys(b.stock)) if(b.stock[pid]>8) b.sellerIdeal[pid]*=0.99;

    if(phase==='Visit 1' && visitsMax===2){
      phase='Visit 2'; phaseEl.textContent=phase; tPhase=0; prepPhase(1);
    }else{
      phase='Returning'; phaseEl.textContent=phase;
      const home=buildings[player.home]; aimTo(player, isoToScreen(home.col,home.row));
      endOfDay();
    }
    if(speed===SPEEDS.skip) speed=SPEEDS.normal;
  }

  render(); requestAnimationFrame(step);
}
function moveAgent(a,dt){ if(!a.target) return; a.x += a.vx*(dt*60); a.y += a.vy*(dt*60); }
function infCheck(a, others, dt){
  if(a.sick) return;
  const baseRate = (a===player? INF_BASE*infectionMultiplier(): INF_BASE);
  const prob = 1 - Math.pow(1 - baseRate, dt);
  for(const o of others){
    if(!o.sick) continue;
    const dx=a.x-o.x, dy=a.y-o.y, d2=dx*dx+dy*dy;
    if(d2 <= INF_RAD*INF_RAD){
      if(Math.random()<prob){
        a.sick=true; a.sickDays=SICK_DAYS;
        if(a===player){ statusEl.textContent=`Sick (${a.sickDays}d)`; statusEl.className='accent bad'; log('You became sick.') }
      }
      break;
    }
  }
}
function maybeBuyWhenArrive(agent,k,playerWorking){
  const id=(agent===player? player.dest[k] : agent.plan[k]); if(id==null) return;
  const b=buildings[id]; if(!b || b.kind!=='biz') return;
  const target=isoToScreen(b.col,b.row);
  const arrived = ((agent.x-target.x)**2 + (agent.y-target.y)**2) < 25;
  if(!arrived) return;

  if(agent!==player){
    if(!agent.didBuy && Math.random()<0.45){
      trySaleAtShop(b, agent, false); agent.didBuy=true;
    }
  }
}
function simulateWorkerSales(k){
  const phaseShops = buildings.filter(b=>b.kind==='biz' && b.owner===0 && b.hired);
  for(const shop of phaseShops){
    const attempts = rint(1,3);
    for(let i=0;i<attempts;i++){
      const cust = {wallet:rint(30,140), priceIdeal:{}};
      for(const pr of PRODUCTS){ cust.priceIdeal[pr.id]=pr.base*rand(0.85,1.15) }
      const pick = Object.keys(shop.stock).filter(pid=>shop.stock[pid]>0);
      if(pick.length===0) break;
      pick.sort((a,b)=> (cust.priceIdeal[a]||999)-(cust.priceIdeal[b]||999));
      const pid=pick[0], p=product(pid);
      const price = Math.round((cust.priceIdeal[pid] + shop.sellerIdeal[pid])/2);
      if(cust.wallet < price) continue;
      shop.stock[pid]--; shop.till+=price;
      const cut = Math.floor(price*0.5);
      player.money += cut; updateTop();
      log(`Worker sold ${p.name} @ ${shop.name} for $${price}. You earned $${cut} (owner cut).`);
      if(shop.stock[pid]<=1) shop.sellerIdeal[pid]*=1.02;
    }
  }
}
function trySaleAtShop(shop, buyer, playerWorking){
  const options=Object.keys(shop.stock).filter(pid=>shop.stock[pid]>0);
  if(options.length===0) return false;
  options.sort((a,b)=> (buyer.priceIdeal[a]||9999)-(buyer.priceIdeal[b]||9999));
  const pid=options[0], p=product(pid);
  const buyerIdeal=buyer.priceIdeal[pid] ?? p.base;
  const sellerIdeal=shop.sellerIdeal[pid] ?? p.base*1.3;
  const price=midPrice(buyerIdeal, sellerIdeal, buyer===player?negotiationEdge():0);
  const hasMoney = (buyer===player? player.money : buyer.wallet) >= price;
  if(!hasMoney) return false;

  if(buyer===player){
    player.money -= price; player.inventory[pid]=(player.inventory[pid]||0)+1;
    // NEW: needs reflect inventory immediately
    refreshNeedsFromInventory();
    updateTop();
  }else{
    buyer.wallet -= price;
  }
  shop.stock[pid]--; shop.till+=price;
  if(playerWorking) { player.money += price; updateTop() }
  if(shop.stock[pid]<=1) shop.sellerIdeal[pid]*=1.02;
  log(`${buyer===player?'You':'A customer'} bought ${p.name} @ ${shop.name} for $${price}.`);
  return true;
}

/* =========================
   END OF DAY
========================= */
function endOfDay(){
  // Consume needs (actually use up items). Badges will re-check after.
  consumeNeeds();

  if(player.sick){ player.sickDays--; if(player.sickDays<=0){ player.sick=false; statusEl.textContent='Healthy'; statusEl.className='accent ok'; log('You recovered!') } else { statusEl.textContent=`Sick (${player.sickDays}d)` } }

  const wages = buildings.filter(b=>b.kind==='biz' && b.owner===0 && b.hired).length * 20;
  if(wages>0){ player.money -= wages; updateTop(); log(`Paid worker wages: $${wages}.`) }

  day++; dayEl.textContent=day; phase='Planning'; phaseEl.textContent=phase; running=false;
  citizens.forEach(a=>{ a.didBuy=false });
  player.dest=[null,null]; v1El.textContent='— (click a business)'; v2El.textContent='— (click a business)';
  // badges re-evaluate from inventory after consumption
  refreshNeedsFromInventory();

  visitsMax = (player.needs.foodOk && player.needs.funOk)? 2 : 1;
  visitsLeft=visitsMax; visitsMaxEl.textContent=visitsMax; visitsLeftEl.textContent=visitsLeft;

  // restock / price relax
  for(const b of buildings) if(b.kind==='biz'){
    for(const pid of Object.keys(b.stock)){ if(b.stock[pid]<8) b.stock[pid]+=rint(0,2) }
    for(const pid of Object.keys(b.sellerIdeal)){ b.sellerIdeal[pid]*=rand(0.98,1.02) }
  }

  log(`Day ${day-1} ended. Meet Food & Fun tomorrow to keep two visits.`);
}

/* =========================
   NEEDS CONSUMPTION (night)
========================= */
function consumeNeeds(){
  // Use up one Food and one Fun item if available
  if((player.inventory.food||0)>0){ player.inventory.food--; }
  if((player.inventory.book||0)>0){ player.inventory.book--; }
  else if((player.inventory.toy||0)>0){ player.inventory.toy--; }
  else if((player.inventory.coffee||0)>0){ player.inventory.coffee--; }
}

/* =========================
   MISC
========================= */
function updateTop(){ moneyEl.textContent=Math.floor(player.money); houseLvEl.textContent=player.houseLv }
function renderBizPane(b, slot){ return renderShopPane(b, slot) }
function bindBizPane(b, slot){ bindShopButtons(b, slot); const buy=gid('buyBtn'); if(buy){ buy.onclick=()=>{ const cost=bizCost(b); if(player.money<cost){log('Not enough money.');return} player.money-=cost; b.owner=0; updateTop(); log(`You bought ${b.name}.`); pane.innerHTML=renderBizPane(b,slot); bindBizPane(b,slot)} } const hire=gid('hireBtn'); if(hire){ hire.onclick=()=>{ b.hired=!b.hired; log(`${b.hired?'Hired':'Fired'} worker at ${b.name}.`); pane.innerHTML=renderBizPane(b,slot); bindBizPane(b,slot)} } }

/* =========================
   LOOP
========================= */
requestAnimationFrame(step);
render();
// initialize badges from starting inventory
refreshNeedsFromInventory();

</script>
</body>
</html>
