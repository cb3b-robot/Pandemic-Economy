<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Pandemic City — Ownership, Needs & Workers</title>
<style>
  :root { --w: 720px; --h: 480px; --cell: 20px; }
  *{box-sizing:border-box}
  body{margin:0;background:#0e1118;color:#eef3ff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;display:flex;flex-direction:column;align-items:center;gap:10px;padding:10px}
  h1{margin:8px 0 4px;font-size:clamp(18px,3.4vw,28px);letter-spacing:.2px}
  #top{display:flex;flex-wrap:wrap;gap:8px;align-items:center;justify-content:center;background:#141a2a;border:1px solid #223152;border-radius:12px;padding:8px 12px}
  .pill{padding:6px 10px;background:#0f1526;border:1px solid #203259;border-radius:10px}
  .accent{color:#9bd6ff}
  .ok{color:#8cf0a7}.warn{color:#ffd47a}.bad{color:#ff8b8b}
  #wrap{display:grid;grid-template-columns: 1fr 1fr;gap:10px;width:min(1100px,98vw)}
  #left,#right{background:#12182a;border:1px solid #223152;border-radius:12px;padding:10px}
  #game{width:var(--w);height:var(--h);background:#161d33;border:1px solid #243458;border-radius:10px;display:block;margin:auto}
  #hover{font-size:12px;opacity:.9}
  #legend{font-size:12px;opacity:.9;line-height:1.35}
  .badge{display:inline-block;padding:2px 6px;border-radius:6px;font-size:12px;margin-left:6px;border:1px solid #2b3c66}
  .b-house{background:#242a44}.b-biz{background:#1d3353}
  #controls{display:flex;flex-wrap:wrap;gap:8px}
  button, label, select{background:#182444;color:#e8f0ff;border:1px solid #2a4070;border-radius:10px;padding:7px 10px;font-size:14px}
  button:hover{filter:brightness(1.08);cursor:pointer}
  #visits{display:flex;gap:10px;flex-wrap:wrap}
  .slot{background:#0f1426;border:1px solid #2a4070;padding:8px;border-radius:10px;min-width:230px}
  #pane{margin-top:8px}
  #log{height:170px;overflow:auto;background:#0f1422;border:1px solid #243458;border-radius:10px;padding:8px;font-size:12px}
  .k{color:#d8e7ff}
</style>
</head>
<body>
<h1>Pandemic City — Ownership, Needs & Workers</h1>

<div id="top">
  <div class="pill">Day: <span id="day" class="accent">1</span></div>
  <div class="pill">Phase: <span id="phase" class="accent">Planning</span></div>
  <div class="pill">Visits: <span id="visitsLeft" class="accent">2</span> / <span id="visitsMax" class="accent">2</span></div>
  <div class="pill">Money: $<span id="money" class="accent">200</span></div>
  <div class="pill">Status: <span id="status" class="accent ok">Healthy</span></div>
  <div class="pill">Needs: Food <span id="nf" class="ok">OK</span> · Fun <span id="ne" class="ok">OK</span></div>
  <div class="pill">House Lv: <span id="houseLv" class="accent">1</span> <button id="expandBtn">Expand ($150)</button></div>
</div>

<div id="wrap">
  <div id="left">
    <canvas id="game" width="720" height="480"></canvas>
    <div id="hover"></div>
    <div id="legend">
      <strong>Legend:</strong> <span class="badge b-house">House</span> <span class="badge b-biz">Business</span> ·
      Agents: Healthy(cyan), Sick(red), You(yellow/orange) · Infection 1%/s within ~12px (reduced by house level). Sick = 7 days.
    </div>
  </div>

  <div id="right">
    <div id="controls">
      <button id="clearBtn">Clear Visits</button>
      <button id="startBtn">Start Day</button>
      <button id="fastBtn">Fast</button>
      <button id="skipBtn">Skip</button>
    </div>

    <div id="visits" style="margin-top:8px">
      <div class="slot">
        <div><strong>Visit 1:</strong> <span id="v1">— (click a business)</span></div>
        <label><input type="checkbox" id="w1"> Work this visit</label>
      </div>
      <div class="slot">
        <div><strong>Visit 2:</strong> <span id="v2">— (click a business)</span></div>
        <label><input type="checkbox" id="w2"> Work this visit</label>
      </div>
    </div>

    <div id="pane"></div>

    <h3 style="margin:10px 0 6px;">City Log</h3>
    <div id="log"></div>
  </div>
</div>

<script>
/* ---------- Config ---------- */
const W=720,H=480,CELL=20, COLS=Math.floor(W/CELL), ROWS=Math.floor(H/CELL);
const GRID="#26365d", HOUSE="#2a3152", BIZ="#1f3a60";
const INF_RAD=12, INF_BASE=0.01, SICK_DAYS=7;
const PHASE_MS=11000; // ~11s per visit
const POP=70, HOUSES=50, SHOPS=24;
const SPEEDS={normal:1,fast:4,skip:999};

/* ---------- Products & shops ---------- */
const PRODUCTS=[
  {id:"food",name:"Food",base:10, need:"food"},
  {id:"med",name:"Medicine",base:26},
  {id:"coffee",name:"Coffee",base:6, need:"fun"},
  {id:"book",name:"Book",base:15, need:"fun"},
  {id:"toy",name:"Toy",base:12, need:"fun"},
  {id:"shirt",name:"Shirt",base:30},
  {id:"gadget",name:"Gadget",base:85},
];
const CATALOG=[
  {type:"Grocery", offers:["food"]},
  {type:"Pharmacy", offers:["med"]},
  {type:"Cafe", offers:["coffee"]},
  {type:"Bookstore", offers:["book"]},
  {type:"Toy Shop", offers:["toy"]},
  {type:"Clothing", offers:["shirt"]},
  {type:"Electronics", offers:["gadget"]},
  {type:"Market", offers:["food","coffee","toy"]},
  {type:"Outlet", offers:["shirt","gadget"]},
];

/* ---------- State ---------- */
const cvs=document.getElementById('game'), ctx=cvs.getContext('2d');
const dayEl=gid('day'), phaseEl=gid('phase'), visitsLeftEl=gid('visitsLeft'), visitsMaxEl=gid('visitsMax');
const moneyEl=gid('money'), statusEl=gid('status'), hoverEl=gid('hover'), pane=gid('pane');
const v1El=gid('v1'), v2El=gid('v2'), w1El=gid('w1'), w2El=gid('w2'), logEl=gid('log');
const houseLvEl=gid('houseLv'), nfEl=gid('nf'), neEl=gid('ne');

let day=1, phase="Planning", speed=SPEEDS.normal;
let visitsMax=2, visitsLeft=2;
let running=false, tPhase=0, lastTs=0;

const buildings=[]; // {id,kind:'house'|'biz',x,y,col,row,name,type,stock,sellerIdeal,owner:-1,hired:false,till}
const citizens=[];  // NPCs
const taken=new Set();

const player={
  x:0,y:0,vx:0,vy:0,target:null,home:null,
  sick:false,sickDays:0, money:200,
  priceIdeal:{}, inventory:{}, dest:[null,null], work:[false,false],
  needs:{foodOk:true, funOk:true, grumpy:false}, houseLv:1
};

/* ---------- Helpers ---------- */
function gid(id){return document.getElementById(id)}
const rint=(a,b)=>Math.floor(Math.random()*(b-a+1))+a;
const rand=(a,b)=>Math.random()*(b-a)+a;
const choice=a=>a[rint(0,a.length-1)];
const dist2=(ax,ay,bx,by)=>(ax-bx)*(ax-bx)+(ay-by)*(ay-by);
function log(s){const d=document.createElement('div'); d.textContent=s; logEl.prepend(d)}
function product(pid){return PRODUCTS.find(p=>p.id===pid)}
function clamp(v,a,b){return Math.max(a,Math.min(b,v))}

/* ---------- City gen ---------- */
function free(c,r){
  if(c<1||r<1||c>COLS-2||r>ROWS-2) return false;
  return !taken.has(c+','+r);
}
function occupy(c,r){taken.add(c+','+r)}
function place(kind, info={}){
  for(let t=0;t<400;t++){
    const c=rint(1,COLS-2), r=rint(1,ROWS-2);
    if(!free(c,r)) continue;
    occupy(c,r);
    const id=buildings.length, x=c*CELL+CELL/2, y=r*CELL+CELL/2;
    const b={id,kind,x,y,col:c,row:r,name: kind==='house' ? 'House '+id : info.name};
    if(kind==='biz'){
      b.type=info.type; b.owner=-1; b.hired=false; b.till=0; b.stock={}; b.sellerIdeal={};
      for(const pid of info.offers){
        b.stock[pid]=rint(6,14);
        b.sellerIdeal[pid]=+(product(pid).base*rand(1.15,1.75)).toFixed(2);
      }
    }
    buildings.push(b); return b;
  }
  return null;
}
function genCity(){
  for(let i=0;i<HOUSES;i++) place('house');
  for(let i=0;i<SHOPS;i++){ const d=choice(CATALOG); place('biz',{type:d.type, name:`${d.type} #${i+1}`, offers:d.offers}) }
  // citizens from random houses
  const houseIds=buildings.filter(b=>b.kind==='house').map(b=>b.id);
  for(let i=0;i<POP;i++){
    const homeId=choice(houseIds), home=buildings[homeId];
    const a={
      id:i,x:home.x,y:home.y,vx:0,vy:0,target:null,home:homeId,
      sick:Math.random()<0.07, sickDays:rint(0,SICK_DAYS), wallet:rint(50,180),
      priceIdeal:{}
    };
    for(const pr of PRODUCTS){ a.priceIdeal[pr.id]=+(pr.base*rand(0.75,1.1)).toFixed(2) }
    citizens.push(a);
  }
  // player
  const ph=choice(houseIds), home=buildings[ph]; player.home=ph; player.x=home.x; player.y=home.y;
  for(const pr of PRODUCTS){ player.priceIdeal[pr.id]=+(pr.base*rand(0.85,1.1)).toFixed(2) }
}
genCity();

/* ---------- Drawing ---------- */
function drawGrid(){
  ctx.strokeStyle=GRID; ctx.lineWidth=1; ctx.beginPath();
  for(let c=0;c<=COLS;c++){ ctx.moveTo(c*CELL,0); ctx.lineTo(c*CELL,H) }
  for(let r=0;r<=ROWS;r++){ ctx.moveTo(0,r*CELL); ctx.lineTo(W,r*CELL) }
  ctx.stroke();
}
function drawBuildings(){
  ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.font='11px system-ui';
  for(const b of buildings){
    ctx.fillStyle=b.kind==='house'?HOUSE:BIZ;
    ctx.fillRect(b.col*CELL+2,b.row*CELL+2,CELL-4,CELL-4);
    if(b.kind==='biz'){
      ctx.fillStyle='#d4e6ff'; ctx.fillText(b.type.split(' ')[0], b.x, b.y);
      if(b.owner===-1) { /* no mark */ }
      else { ctx.strokeStyle='#ffd66b'; ctx.strokeRect(b.col*CELL+4, b.row*CELL+4, CELL-8, CELL-8) }
    }
  }
}
function drawAgents(){
  for(const c of citizens){ ctx.beginPath(); ctx.fillStyle=c.sick?'#ff6c6c':'#62e3ff'; ctx.arc(c.x,c.y,4.5,0,Math.PI*2); ctx.fill() }
  ctx.beginPath(); ctx.fillStyle=player.sick?'#ffb66b':'#ffe36b'; ctx.arc(player.x,player.y,6.5,0,Math.PI*2); ctx.fill()
}
function render(){ ctx.clearRect(0,0,W,H); drawGrid(); drawBuildings(); drawAgents() }

/* ---------- Hover & click ---------- */
function buildingAt(px,py){
  for(const b of buildings){ if(Math.abs(b.x-px)<=CELL/2 && Math.abs(b.y-py)<=CELL/2) return b }
  return null;
}
cvs.addEventListener('mousemove',e=>{
  const r=cvs.getBoundingClientRect(), x=e.clientX-r.left, y=e.clientY-r.top;
  const b=buildingAt(x,y);
  if(!b){ hoverEl.textContent=''; return }
  if(b.kind==='house'){ hoverEl.textContent=`${b.name} (House)` }
  else{
    const offers=Object.keys(b.stock).map(pid=>{
      const inv=b.stock[pid], ask=b.sellerIdeal[pid].toFixed(2); return `${product(pid).name}: inv ${inv}, ask ~$${ask}`
    }).join(' · ');
    const own = b.owner===-1? 'Unowned' : (b.owner===0? 'Owned by You' : 'Owned');
    hoverEl.textContent=`${b.name} (${b.type}) — ${offers} — ${own}${b.hired?' · Worker hired':''}`;
  }
});
cvs.addEventListener('click',e=>{
  if(phase!=='Planning') return;
  const r=cvs.getBoundingClientRect(), x=e.clientX-r.left, y=e.clientY-r.top;
  const b=buildingAt(x,y); if(!b || b.kind!=='biz') return;

  const slot = player.dest[0]==null?0: (player.dest[1]==null?1:-1);
  if(slot===-1){ log('Both visits selected. Use Clear Visits to change.'); return }
  player.dest[slot]=b.id; (slot? v2El:v1El).textContent=`${b.name} (${b.type})`;
  visitsLeft = visitsMax - (player.dest.filter(v=>v!=null).length); visitsLeftEl.textContent=visitsLeft;

  // Show business pane for buy/hire & shopping preview
  pane.innerHTML=renderBizPane(b, slot);
  bindBizPane(b, slot);
});

/* ---------- UI controls ---------- */
gid('clearBtn').onclick=()=>{
  player.dest=[null,null]; v1El.textContent='— (click a business)'; v2El.textContent='— (click a business)';
  visitsLeft=visitsMax; visitsLeftEl.textContent=visitsLeft; pane.innerHTML='';
};
gid('startBtn').onclick=startDay;
gid('fastBtn').onclick=()=>{ speed = (speed===SPEEDS.fast?SPEEDS.normal:SPEEDS.fast); log(`Speed: ${speed===SPEEDS.fast?'Fast':'Normal'}`) };
gid('skipBtn').onclick=()=>{ speed=SPEEDS.skip; log('Skipping…') };
gid('expandBtn').onclick=()=>{
  const cost = 150 + (player.houseLv-1)*100;
  if(player.money < cost){ log('Not enough money to expand house.'); return }
  player.money -= cost; player.houseLv++; updateTop();
  log(`House expanded to Lv ${player.houseLv}. Infection risk slightly reduced and negotiation improved.`);
};

/* ---------- Planning → Day ---------- */
function startDay(){
  if(running) return;
  // needs from yesterday might shrink visits
  visitsMax = (player.needs.foodOk && player.needs.funOk) ? 2 : 1;
  visitsLeft = visitsMax; visitsMaxEl.textContent=visitsMax; visitsLeftEl.textContent=visitsLeft;

  if(player.sick){
    player.dest=[player.home, player.home]; v1El.textContent='(Sick) Stay Home'; v2El.textContent='(Sick) Stay Home';
    w1El.checked=false; w2El.checked=false; player.work=[false,false];
  }else{
    for(let i=0;i<visitsMax;i++) if(player.dest[i]==null){
      const ids=buildings.filter(b=>b.kind==='biz').map(b=>b.id); const id=choice(ids); player.dest[i]=id;
      (i? v2El:v1El).textContent=buildings[id].name;
    }
    // If only 1 visit max, null the second
    if(visitsMax===1){ player.dest[1]=null; v2El.textContent='— (locked; meet your needs)'; w2El.checked=false }
    player.work=[!!w1El.checked, !!w2El.checked && visitsMax===2];
  }

  // citizens plan
  for(const a of citizens){
    if(a.sick){ a.plan=[a.home, a.home] }
    else{
      const ids=buildings.filter(b=>b.kind==='biz').map(b=>b.id);
      a.plan=[choice(ids), choice(ids)]
    }
  }

  tPhase=0; lastTs=0; speed=SPEEDS.normal; phase='Visit 1'; phaseEl.textContent=phase; running=true;
  prepPhase(0);
  log(`Day ${day} started.`);
}

function prepPhase(k){
  // aim everyone
  aimTo(player, destPoint(player, k));
  for(const a of citizens){ aimTo(a, destPoint(a, k)) }

  // open pane if you’re going to a biz
  pane.innerHTML='';
  const destId=player.dest[k];
  if(destId!=null){
    const b=buildings[destId];
    if(b.kind==='biz'){ pane.innerHTML=renderShopPane(b, k); bindShopButtons(b, k) }
  }
}

function destPoint(agent,k){
  const id=(agent===player? player.dest[k] : agent.plan[k]);
  if(id==null) return {x:buildings[player.home].x, y:buildings[player.home].y};
  const b=buildings[id]; return {x:b.x, y:b.y}
}
function aimTo(agent, pt){
  const dx=pt.x-agent.x, dy=pt.y-agent.y, steps=(PHASE_MS/16.7);
  agent.vx=dx/steps; agent.vy=dy/steps; agent.target=pt;
}

/* ---------- Economy ---------- */
function midPrice(buyerIdeal,sellerIdeal,edge=0){
  // House comfort gives slight edge to you: move mid a bit toward buyer
  const p=(buyerIdeal+sellerIdeal)/2;
  return Math.round(p - edge*(sellerIdeal-buyerIdeal));
}
function renderBizPane(b,slot){
  const own = b.owner===0;
  const buyCost = bizCost(b);
  const hireRow = own ? `<div>Worker: <strong>${b.hired?'Hired':'None'}</strong> 
      <button id="hireBtn">${b.hired?'Fire (no cost)':'Hire ($20/day)'}</button></div>` : '';
  return `
  <div class="slot">
    <div><strong>${b.name}</strong> <span class="badge b-biz">${b.type}</span> — ${b.owner===-1?'Unowned':(own?'Owned by You':'Owned')}</div>
    ${!own && b.owner===-1 ? `<button id="buyBtn">Buy ($${buyCost})</button>` : ''}
    ${hireRow}
    <div style="margin-top:6px"><em>Preview stock & midpoint prices:</em></div>
    <ul style="list-style:none;padding-left:14px;text-align:left">
      ${Object.keys(b.stock).map(pid=>{
        const p=product(pid), you=player.priceIdeal[pid], ask=b.sellerIdeal[pid], edge=negotiationEdge();
        const price=midPrice(you,ask,edge);
        return `<li>${p.name}: inv <strong>${b.stock[pid]}</strong> · your ideal $${you.toFixed(2)} · seller $${ask.toFixed(2)} → <strong>$${price}</strong></li>`
      }).join('') || '<li>Sold out.</li>'}
    </ul>
    <div style="font-size:12px;opacity:.85">Price = midpoint between your ideal and seller’s ideal (Primer-style). House level improves your edge slightly.</div>
  </div>`;
}
function bindBizPane(b,slot){
  const buy=gid('buyBtn'); if(buy){ buy.onclick=()=>{ const cost=bizCost(b); if(player.money<cost){log('Not enough money.');return} player.money-=cost; b.owner=0; updateTop(); log(`You bought ${b.name}.`); pane.innerHTML=renderBizPane(b,slot); bindBizPane(b,slot)} }
  const hire=gid('hireBtn'); if(hire){ hire.onclick=()=>{ b.hired=!b.hired; log(`${b.hired?'Hired':'Fired'} worker at ${b.name}.`); pane.innerHTML=renderBizPane(b,slot); bindBizPane(b,slot)} }
}
function bizCost(b){
  // base on stock value * markup
  let val=0; for(const pid of Object.keys(b.stock)){ val += b.stock[pid]*product(pid).base }
  val = Math.max(120, Math.round(val*1.8));
  return val;
}
function negotiationEdge(){
  // tiny drift toward your price: 0.0..0.15 (houseLv + not-grumpy)
  let edge = 0.03 + (player.houseLv-1)*0.02;
  if(player.needs.grumpy) edge -= 0.02;
  return clamp(edge, 0, 0.15);
}
function trySaleAtShop(shop, buyer, playerWorking=false){
  if(!shop || shop.kind!=='biz') return false;
  const options=Object.keys(shop.stock).filter(pid=>shop.stock[pid]>0);
  if(options.length===0) return false;

  // pick the item buyer values most
  options.sort((a,b)=> (buyer.priceIdeal[a]||9999)-(buyer.priceIdeal[b]||9999));
  const pid=options[0], p=product(pid);
  const buyerIdeal=buyer.priceIdeal[pid] ?? p.base;
  const sellerIdeal=shop.sellerIdeal[pid] ?? p.base*1.3;
  const price=midPrice(buyerIdeal, sellerIdeal, buyer===player?negotiationEdge():0);

  const hasMoney = (buyer===player? player.money : buyer.wallet) >= price;
  if(!hasMoney) return false;

  // transact
  if(buyer===player){
    player.money -= price; player.inventory[pid]=(player.inventory[pid]||0)+1; updateTop();
  }else{
    buyer.wallet -= price;
  }
  shop.stock[pid]--; shop.till += price;

  // wages: if player Working here now → they earn 100% of sales they directly trigger
  if(playerWorking) { player.money += price; updateTop() }

  log(`${buyer===player?'You':'A customer'} bought ${p.name} @ ${shop.name} for $${price}.`);

  // adaptive price
  if(shop.stock[pid]<=1) shop.sellerIdeal[pid]*=1.02;
  return true;
}
function renderShopPane(b,k){
  const working = !!player.work[k];
  return `
    <div class="slot">
      <div><strong>At ${b.name}</strong> <span class="badge b-biz">${b.type}</span> ${b.owner===0?'· <span class="k">Your business</span>':''} ${working? '· <strong>Working</strong>' : '· Browsing'}</div>
      <div style="margin:6px 0">Money: $${Math.floor(player.money)} · Inventory: ${invString()}</div>
      <ul style="list-style:none;padding-left:14px;text-align:left">
        ${Object.keys(b.stock).map(pid=>{
          const p=product(pid), you=player.priceIdeal[pid], ask=b.sellerIdeal[pid], edge=negotiationEdge();
          const price=midPrice(you,ask,edge);
          return `<li>${p.name}: inv <strong>${b.stock[pid]}</strong> · you $${you.toFixed(2)} · seller $${ask.toFixed(2)} → <strong>$${price}</strong> <button data-buy="${pid}" ${b.stock[pid]<=0?'disabled':''}>Buy</button></li>`
        }).join('') || '<li>Sold out.</li>'}
      </ul>
      <div style="font-size:12px;opacity:.85">If you work here this phase, you earn 100% of sales you cause. If this shop is yours and has a worker, you earn 50% of their sales (owner cut).</div>
    </div>
  `;
}
function bindShopButtons(b,k){
  pane.querySelectorAll('button[data-buy]').forEach(btn=>{
    btn.onclick=()=>{
      const pid=btn.getAttribute('data-buy');
      // do a targeted buy using current mid price
      if(b.stock[pid]<=0){ log('Out of stock.'); return }
      const p=product(pid), you=player.priceIdeal[pid], ask=b.sellerIdeal[pid], edge=negotiationEdge();
      const price=midPrice(you,ask,edge);
      if(player.money<price){ log(`Not enough money for ${p.name} ($${price}).`); return }
      player.money-=price; player.inventory[pid]=(player.inventory[pid]||0)+1; b.stock[pid]--; b.till+=price;
      if(player.work[k]){ player.money+=price } // you worked → you get the sale
      if(b.stock[pid]<=1) b.sellerIdeal[pid]*=1.02;
      updateTop(); pane.innerHTML=renderShopPane(b,k); bindShopButtons(b,k);
      log(`You bought ${p.name} @ ${b.name} for $${price}.`);
    };
  });
}
function invString(){
  const keys=Object.keys(player.inventory).filter(k=>player.inventory[k]>0);
  if(keys.length===0) return '(empty)';
  return keys.map(k=>`${product(k).name}×${player.inventory[k]}`).join(', ');
}

/* ---------- Needs ---------- */
function consumeNeeds(){
  // require 1 Food and 1 Fun per day
  let foodOK=false, funOK=false;

  if((player.inventory.food||0)>0){ player.inventory.food--; foodOK=true }
  if((player.inventory.book||0)>0){ player.inventory.book--; funOK=true }
  else if((player.inventory.toy||0)>0){ player.inventory.toy--; funOK=true }
  else if((player.inventory.coffee||0)>0){ player.inventory.coffee--; funOK=true }

  player.needs.foodOk=foodOK; player.needs.funOk=funOK; player.needs.grumpy=!(foodOK&&funOK);
  nfEl.className=foodOK?'ok':'bad'; nfEl.textContent=foodOK?'OK':'NEEDED';
  neEl.className=funOK?'ok':'bad'; neEl.textContent=funOK?'OK':'NEEDED';
}

/* ---------- Infection ---------- */
function infectionMultiplier(){
  // House gives small protection: each level after 1 reduces risk 8%, min 50% of base
  const mult = Math.max(0.5, 1 - 0.08*(player.houseLv-1));
  return mult;
}

/* ---------- Sim loop ---------- */
function step(ts){
  if(!running){ render(); requestAnimationFrame(step); return }
  if(!lastTs) lastTs=ts;
  let dt=(ts-lastTs)/1000; lastTs=ts; dt*=speed;

  // move
  moveAgent(player,dt);
  for(const a of citizens) moveAgent(a,dt);

  // infection checks ~ once per second granularity using dt
  infCheck(player, citizens, dt);
  for(const c of citizens) infCheck(c, [player,...citizens], dt);

  // arrivals & shopping
  const k = (phase==='Visit 1'?0:(phase==='Visit 2'?1:null));
  const working = (k!=null) && player.work[k];
  if(k!=null){
    // owned shops with workers: simulate worker-driven sales → owner gets 50%
    simulateWorkerSales(k);
    // NPCs buy on arrival chance
    citizens.forEach(a=>maybeBuyWhenArrive(a,k,false));
    maybeBuyWhenArrive(player,k,working);
  }

  // timer end
  tPhase += dt*1000;
  if(tPhase>=PHASE_MS || speed===SPEEDS.skip){
    // adapt prices down slightly if plenty left
    for(const b of buildings) if(b.kind==='biz'){
      for(const pid of Object.keys(b.stock)) if(b.stock[pid]>8) b.sellerIdeal[pid]*=0.99;
    }
    if(phase==='Visit 1' && visitsMax===2){
      phase='Visit 2'; phaseEl.textContent=phase; tPhase=0; prepPhase(1);
    }else{
      // return home and finish day
      phase='Returning'; phaseEl.textContent=phase;
      aimTo(player, {x:buildings[player.home].x, y:buildings[player.home].y});
      endOfDay();
    }
    if(speed===SPEEDS.skip) speed=SPEEDS.normal;
  }

  render(); requestAnimationFrame(step);
}
function moveAgent(a,dt){
  if(!a.target) return;
  a.x += a.vx*(dt*60); a.y += a.vy*(dt*60);
}
function infCheck(a, others, dt){
  if(a.sick) return;
  // approximate: roll chance proportional to dt
  const baseRate = (a===player? INF_BASE*infectionMultiplier(): INF_BASE);
  let prob = 1 - Math.pow(1 - baseRate, dt); // convert per-sec rate to dt
  for(const o of others){
    if(!o.sick) continue;
    if(dist2(a.x,a.y,o.x,o.y) <= INF_RAD*INF_RAD){
      if(Math.random() < prob){
        a.sick=true; a.sickDays=SICK_DAYS;
        if(a===player){ statusEl.textContent=`Sick (${a.sickDays}d)`; statusEl.className='accent bad'; log('You became sick.') }
        break;
      }
    }
  }
}
function maybeBuyWhenArrive(agent,k,playerWorking){
  const id=(agent===player? player.dest[k] : agent.plan[k]); if(id==null) return;
  const b=buildings[id]; if(!b || b.kind!=='biz') return;
  const arrived = dist2(agent.x,agent.y,b.x,b.y) < 6;
  if(!arrived) return;

  if(agent!==player){
    // ~45% chance to attempt a buy once
    if(!agent.didBuy) { agent.didBuy=true; trySaleAtShop(b, agent, false) }
  }else{
    // player may choose to buy via pane buttons; but auto one free browse chance
    if(!agent.didAutoBrowse){ agent.didAutoBrowse=true; /* no auto-buy to avoid unwanted spend */ }
  }
}
function simulateWorkerSales(k){
  // For each OWNED shop with worker hired, run a few random customer attempts; owner earns 50% of successful sales
  const phaseShops = buildings.filter(b=>b.kind==='biz' && b.owner===0 && b.hired);
  for(const shop of phaseShops){
    const attempts = rint(1,3); // modest footfall per phase
    for(let i=0;i<attempts;i++){
      // synthesize a customer using average ideals
      const cust = {wallet:rint(30,140), priceIdeal:{}};
      for(const pr of PRODUCTS){ cust.priceIdeal[pr.id]=pr.base*rand(0.85,1.15) }
      // pick cheapest available
      const pick = Object.keys(shop.stock).filter(pid=>shop.stock[pid]>0);
      if(pick.length===0) break;
      pick.sort((a,b)=> (cust.priceIdeal[a]||999)-(cust.priceIdeal[b]||999));
      const pid=pick[0], p=product(pid);
      const price = Math.round((cust.priceIdeal[pid] + shop.sellerIdeal[pid])/2);
      if(cust.wallet < price) continue;
      // execute sale
      shop.stock[pid]--; shop.till+=price;
      // owner cut 50%
      const cut = Math.floor(price*0.5);
      player.money += cut; updateTop();
      log(`Worker sold ${p.name} @ ${shop.name} for $${price}. You earned $${cut} (owner cut).`);
      if(shop.stock[pid]<=1) shop.sellerIdeal[pid]*=1.02;
    }
  }
}

/* ---------- End of day ---------- */
function endOfDay(){
  // consume needs at night
  consumeNeeds();

  // sickness ticks
  if(player.sick){ player.sickDays--; if(player.sickDays<=0){ player.sick=false; statusEl.textContent='Healthy'; statusEl.className='accent ok'; log('You recovered!') } else { statusEl.textContent=`Sick (${player.sickDays}d)` } }

  // worker wages (flat 20 if hired anywhere)
  const wages = buildings.filter(b=>b.kind==='biz' && b.owner===0 && b.hired).length * 20;
  if(wages>0){ player.money -= wages; updateTop(); log(`Paid worker wages: $${wages}.`) }

  // next day
  day++; dayEl.textContent=day; phase='Planning'; phaseEl.textContent=phase; running=false;
  // reset flags
  citizens.forEach(a=>{ a.didBuy=false }); player.didAutoBrowse=false;
  // reset visits UI
  player.dest=[null,null]; v1El.textContent='— (click a business)'; v2El.textContent='— (click a business)';
  visitsMax = (player.needs.foodOk && player.needs.funOk)? 2 : 1;
  visitsLeft=visitsMax; visitsMaxEl.textContent=visitsMax; visitsLeftEl.textContent=visitsLeft;

  // slight nightly restock and price relax
  for(const b of buildings) if(b.kind==='biz'){
    for(const pid of Object.keys(b.stock)){ if(b.stock[pid]<8) b.stock[pid]+=rint(0,2) }
    for(const pid of Object.keys(b.sellerIdeal)){ b.sellerIdeal[pid]*=rand(0.98,1.02) }
  }

  log(`Day ${day-1} ended. Needs for next day — Food & Fun. Plan wisely.`);
}

/* ---------- Top bar ---------- */
function updateTop(){
  moneyEl.textContent=Math.floor(player.money);
  houseLvEl.textContent=player.houseLv;
}

/* ---------- Kick off ---------- */
requestAnimationFrame(step);
render();

/* ---------- Shop Pane during planning ---------- */
function renderBizPane(b, slot){ return renderShopPane(b, slot) } // reuse
function bindBizPane(b, slot){ bindShopButtons(b, slot); /* plus buy/hire handled in renderBizPane during planning */ }

</script>
</body>
</html>
