<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Pandemic City — Isometric + Personalities + Food/Fun Rule</title>
<style>
  :root { --w: 900px; --h: 560px; }
  *{box-sizing:border-box}
  body{margin:0;background:#0c0f16;color:#eef3ff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;display:flex;flex-direction:column;align-items:center;gap:10px;padding:10px}
  h1{margin:8px 0 4px;font-size:clamp(18px,3.2vw,28px)}
  #top{display:flex;flex-wrap:wrap;gap:8px;align-items:center;justify-content:center;background:#141a2a;border:1px solid #223152;border-radius:12px;padding:8px 12px}
  .pill{padding:6px 10px;background:#0f1526;border:1px solid #203259;border-radius:10px}
  .accent{color:#9bd6ff}.ok{color:#8cf0a7}.bad{color:#ff8b8b}
  #wrap{display:grid;grid-template-columns: 1fr 1fr;gap:10px;width:min(1200px,98vw)}
  #left,#right{background:#12182a;border:1px solid #223152;border-radius:12px;padding:10px}
  #game{width:var(--w);height:var(--h);background:#0e1423;border:1px solid #23314f;border-radius:10px;display:block;margin:auto}
  #hover{font-size:12px;opacity:.9;margin-top:4px;min-height:16px}
  #controls{display:flex;flex-wrap:wrap;gap:8px}
  button,label{background:#182444;color:#e8f0ff;border:1px solid #2a4070;border-radius:10px;padding:7px 10px;font-size:14px}
  button:hover{filter:brightness(1.08);cursor:pointer}
  #visits{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
  .slot{background:#0f1426;border:1px solid #2a4070;padding:8px;border-radius:10px;min-width:240px}
  #pane{margin-top:8px}
  #log{height:170px;overflow:auto;background:#0f1422;border:1px solid #243458;border-radius:10px;padding:8px;font-size:12px}
  /* Interior overlay */
  #interiorWrap{
    position:fixed; inset:0; display:none; align-items:center; justify-content:center;
    background:rgba(6,10,20,.75); z-index:9999; padding:12px;
  }
  #interiorCard{ width:min(860px, 96vw); background:#0f1424; border:1px solid #2a3b67; border-radius:14px; padding:10px; }
  #interiorTop{display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:6px}
  #interiorTitle{font-weight:600}
  #interior{width:100%; height:420px; background:#0e1322; border:1px solid #243458; border-radius:10px}
  #sellerList{display:flex; gap:8px; flex-wrap:wrap; margin-top:8px}
  .sellerCard{ background:#111a33; border:1px solid #26407a; border-radius:10px; padding:8px; min-width:220px; flex:1; }
  .sellerCard h4{margin:2px 0 6px}
  .mini{font-size:12px; opacity:.9}
  .badge{display:inline-block; padding:2px 6px; border-radius:8px; border:1px solid #2f4475; font-size:12px; margin-left:6px}
</style>
</head>
<body>
<h1>Pandemic City — Isometric + Personalities + Food/Fun Rule</h1>

<div id="top">
  <div class="pill">Day: <span id="day" class="accent">1</span></div>
  <div class="pill">Phase: <span id="phase" class="accent">Planning</span></div>
  <div class="pill">Visits: <span id="visitsLeft" class="accent">2</span> / <span id="visitsMax" class="accent">2</span></div>
  <div class="pill">Money: $<span id="money" class="accent">200</span></div>
  <div class="pill">Status: <span id="status" class="accent ok">Healthy</span></div>
  <div class="pill">Needs: Food <span id="nf" class="ok">OK</span> · Fun <span id="ne" class="ok">OK</span></div>
  <div class="pill">House Lv: <span id="houseLv" class="accent">1</span> <button id="expandBtn">Expand ($150)</button></div>
</div>

<div id="wrap">
  <div id="left">
    <canvas id="game" width="900" height="560"></canvas>
    <div id="hover"></div>
  </div>

  <div id="right">
    <div id="controls">
      <button id="clearBtn">Clear Visits</button>
      <button id="startBtn">Start Day</button>
      <button id="fastBtn">Fast</button>
      <button id="skipBtn">Skip</button>
    </div>
    <div id="visits">
      <div class="slot">
        <div><strong>Visit 1:</strong> <span id="v1">— (click a business)</span></div>
        <label><input type="checkbox" id="w1"> Work this visit</label>
      </div>
      <div class="slot">
        <div><strong>Visit 2:</strong> <span id="v2">— (click a business)</span></div>
        <label><input type="checkbox" id="w2"> Work this visit</label>
      </div>
    </div>
    <div id="pane"></div>
    <h3 style="margin:10px 0 6px;">City Log</h3>
    <div id="log"></div>
  </div>
</div>

<!-- Interior overlay -->
<div id="interiorWrap" role="dialog" aria-modal="true">
  <div id="interiorCard">
    <div id="interiorTop">
      <div id="interiorTitle">Inside: <span id="interiorName"></span></div>
      <div>
        <button id="leaveStoreBtn">Leave</button>
      </div>
    </div>
    <canvas id="interior" width="840" height="420"></canvas>
    <div id="sellerList"></div>
  </div>
</div>

<script>
/* =========================
   ISOMETRIC + CORE SETTINGS
========================= */
const W=900,H=560;
const GRID_COLS=28, GRID_ROWS=18;
const TILE_W=44, TILE_H=22;
const ELEV=18;
const ORIGIN_X=W/2, ORIGIN_Y=88;

function isoToScreen(col,row,z=0){
  const x = (col - row) * (TILE_W/2);
  const y = (col + row) * (TILE_H/2) - z;
  return {x: ORIGIN_X + x, y: ORIGIN_Y + y};
}
function screenToIso(sx,sy){
  sx -= ORIGIN_X; sy -= ORIGIN_Y;
  const col = Math.floor((sy / (TILE_H/2) + sx / (TILE_W/2)) / 2);
  const row = Math.floor((sy / (TILE_H/2) - sx / (TILE_W/2)) / 2);
  return {col,row};
}

/* =========================
   GAME CONSTANTS
========================= */
const PHASE_MS = 11000;
const RETURN_MS = 3000;          // walk-home visual window
const INF_BASE = 0.01;
const INF_RAD  = 16;
const SICK_DAYS= 7;
const POP      = 70;
const HOUSES   = 45;
const SHOPS    = 26;
const SPEEDS   = {normal:1,fast:4,skip:999};
const SICK_FORGET_PROB = 0.25;   // sick NPCs may still go out

// product catalog
const PRODUCTS=[
  {id:"food",name:"Food",base:10, need:"food"},
  {id:"med",name:"Medicine",base:26},
  {id:"coffee",name:"Coffee",base:6, need:"fun"},
  {id:"book",name:"Book",base:15, need:"fun"},
  {id:"toy",name:"Toy",base:12, need:"fun"},
  {id:"shirt",name:"Shirt",base:30},
  {id:"gadget",name:"Gadget",base:85},
];
// store types
const CATALOG=[
  {type:"Grocery", offers:["food"]},                   // FOOD
  {type:"Pharmacy", offers:["med"]},
  {type:"Cafe", offers:["coffee"]},                    // FUN
  {type:"Bookstore", offers:["book"]},                 // FUN
  {type:"Toy Shop", offers:["toy"]},                   // FUN
  {type:"Clothing", offers:["shirt"]},
  {type:"Electronics", offers:["gadget"]},
  {type:"Market", offers:["food","coffee","toy"]},     // BOTH (counts as either)
  {type:"Outlet", offers:["shirt","gadget"]},
];
const FUN_IDS = new Set(["coffee","book","toy"]);
const FOOD_IDS = new Set(["food"]);

/* =========================
   SELLER PERSONALITIES
========================= */
const PERSONAS = [
  {id:"friendly",  title:"Friendly",  color:"#7ee6a5", desc:"gives small breaks",
   askMul:0.95, edgeBonus:+0.02},
  {id:"haggler",   title:"Haggler",   color:"#ffd37e", desc:"starts high, tough negotiator",
   askMul:1.10, edgeBonus:-0.01},
  {id:"gouger",    title:"Gouger",    color:"#ff9898", desc:"surges when stock is low",
   askMul:1.05, lowStockMarkup:0.20},
  {id:"steady",    title:"Steady",    color:"#9ec9ff", desc:"fair & consistent",
   askMul:1.00},
  {id:"impulsive", title:"Impulsive", color:"#caa8ff", desc:"prices wobble",
   askMul:1.00, jitter:0.08},
  {id:"bulk",      title:"Bulk",      color:"#a8ffd1", desc:"cheaper with plenty stock",
   askMul:1.05, bulkDiscount:0.06}, // applies when stock high
];

/* =========================
   STATE
========================= */
const cvs=document.getElementById('game'), ctx=cvs.getContext('2d');
const dayEl=gid('day'), phaseEl=gid('phase'), visitsLeftEl=gid('visitsLeft'), visitsMaxEl=gid('visitsMax');
const moneyEl=gid('money'), statusEl=gid('status'), hoverEl=gid('hover'), pane=gid('pane');
const v1El=gid('v1'), v2El=gid('v2'), w1El=gid('w1'), w2El=gid('w2'), logEl=gid('log');
const houseLvEl=gid('houseLv'), nfEl=gid('nf'), neEl=gid('ne');

const interiorWrap=gid('interiorWrap'), interiorName=gid('interiorName');
const interiorCanvas=gid('interior'), ictx=interiorCanvas.getContext('2d');
const sellerList=gid('sellerList'), leaveStoreBtn=gid('leaveStoreBtn');

let day=1, phase="Planning", speed=SPEEDS.normal;
let visitsMax=2, visitsLeft=2, running=false, tPhase=0, lastTs=0;

const buildings=[];
const citizens=[];
const taken = new Set();

const player={
  col:0,row:0, x:0,y:0, vx:0,vy:0, target:null, home:null,
  sick:false,sickDays:0, money:200,
  priceIdeal:{}, inventory:{}, dest:[null,null], work:[false,false],
  needs:{foodOk:true, funOk:true, grumpy:false}, houseLv:1,
  inStore:null, currentPhaseIndex:null,
};

function gid(id){return document.getElementById(id)}
const rint=(a,b)=>Math.floor(Math.random()*(b-a+1))+a;
const rand=(a,b)=>Math.random()*(b-a)+a;
const choice=a=>a[rint(0,a.length-1)];
const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
function product(pid){return PRODUCTS.find(p=>p.id===pid)}
function log(s){const d=document.createElement('div'); d.textContent=s; logEl.prepend(d)}
function hsl(h,s,l){ return `hsl(${h} ${s}% ${l}%)` }

/* =========================
   CITY GENERATION
========================= */
function free(c,r){ if(c<1||r<1||c>GRID_COLS-2||r>GRID_ROWS-2) return false; return !taken.has(c+','+r) }
function occupy(c,r){taken.add(c+','+r)}
function place(kind, info={}){
  for(let t=0;t<500;t++){
    const c=rint(1,GRID_COLS-2), r=rint(1,GRID_ROWS-2);
    if(!free(c,r)) continue;
    occupy(c,r);
    const id=buildings.length;
    const b={id, kind, col:c, row:r, name: kind==='house' ? 'House '+id : info.name};
    if(kind==='biz'){
      b.type=info.type; b.owner=-1; b.hired=false; b.till=0; b.stock={}; b.sellerIdeal={};
      for(const pid of info.offers){
        b.stock[pid]=rint(6,14);
        b.sellerIdeal[pid]=+(product(pid).base*rand(1.15,1.75)).toFixed(2);
      }
      // sellers with personalities
      b.sellers = makeSellersFor(b);
    }
    buildings.push(b); return b;
  }
  return null;
}
function makeSellersFor(b){
  const n = rint(3,5);
  const ids = Object.keys(b.stock);
  const sellers=[];
  for(let i=0;i<n;i++){
    const offerCount = Math.min(ids.length, rint(1, Math.min(2, ids.length)));
    const myOffers = shuffle(ids).slice(0, offerCount);
    const persona = choice(PERSONAS);
    sellers.push({
      name: randomSellerName(),
      persona,
      offers: myOffers,
    });
  }
  return sellers;
}
function shuffle(a){ return [...a].sort(()=>Math.random()-0.5) }
function randomSellerName(){
  const first = ["Ari","Bo","Cora","Dax","Eli","Fia","Gus","Hana","Ira","Jae","Kai","Lux","Mio","Nia","Ori","Pax","Rio","Sol","Tao","Uma","Vik","Wyn","Xan","Yui","Zed"];
  return choice(first);
}

function genCity(){
  for(let i=0;i<HOUSES;i++) place('house');
  for(let i=0;i<SHOPS;i++){ const d=choice(CATALOG); place('biz',{type:d.type,name:`${d.type} #${i+1}`,offers:d.offers}) }
  // citizens (FEWER sick: 3%)
  const houseIds=buildings.filter(b=>b.kind==='house').map(b=>b.id);
  for(let i=0;i<POP;i++){
    const h=choice(houseIds), bh=buildings[h];
    const {x,y}=isoToScreen(bh.col,bh.row);
    const c={id:i, col:bh.col,row:bh.row, x,y, vx:0,vy:0, target:null, home=h,
      sick:Math.random()<0.03, sickDays:rint(0,SICK_DAYS), wallet:rint(50,180), priceIdeal:{}};
    for(const pr of PRODUCTS){ c.priceIdeal[pr.id]=+(pr.base*rand(0.75,1.1)).toFixed(2) }
    citizens.push(c);
  }
  // player
  const ph=choice(houseIds), home=buildings[ph]; player.home=ph; player.col=home.col; player.row=home.row;
  const ps=isoToScreen(home.col,home.row); player.x=ps.x; player.y=ps.y;
  for(const pr of PRODUCTS){ player.priceIdeal[pr.id]=+(pr.base*rand(0.85,1.1)).toFixed(2) }
}
genCity();

/* =========================
   RENDER — City (iso)
========================= */
function drawDiamond(cx,cy,w,h,fill){ ctx.beginPath(); ctx.moveTo(cx, cy-h/2); ctx.lineTo(cx+w/2, cy); ctx.lineTo(cx, cy+h/2); ctx.lineTo(cx-w/2, cy); ctx.closePath(); ctx.fillStyle=fill; ctx.fill(); }
function drawGround(){
  for(let r=0;r<GRID_ROWS;r++){
    for(let c=0;c<GRID_COLS;c++){
      const p=isoToScreen(c,r);
      const onRoad = (c%4===0)||(r%4===0);
      if(onRoad){ drawDiamond(p.x,p.y,TILE_W,TILE_H,"#1a1f2a"); }
      else{
        const dark=((c+r)&1)===0;
        drawDiamond(p.x,p.y,TILE_W,TILE_H, dark? "#0f1831":"#101a36");
      }
    }
  }
}
function drawRoofTop(x,y,w,h,z,topColor){
  ctx.beginPath();
  ctx.moveTo(x, y - h/2 - z);
  ctx.lineTo(x + w/2, y - z);
  ctx.lineTo(x, y + h/2 - z);
  ctx.lineTo(x - w/2, y - z);
  ctx.closePath();
  const g=ctx.createLinearGradient(x-w/2, y-h/2-z, x+w/2, y+h/2-z);
  g.addColorStop(0, topColor);
  g.addColorStop(1, shade(topColor, -0.1));
  ctx.fillStyle=g; ctx.fill();
  ctx.strokeStyle=shade(topColor, 0.25); ctx.lineWidth=1; ctx.stroke();
}
function drawSideFaces(x,y,w,h,z,leftColor,rightColor){
  // right
  ctx.beginPath(); ctx.moveTo(x + w/2, y - z); ctx.lineTo(x + w/2, y); ctx.lineTo(x, y + h/2); ctx.lineTo(x, y + h/2 - z); ctx.closePath();
  ctx.fillStyle=rightColor; ctx.fill();
  // left
  ctx.beginPath(); ctx.moveTo(x - w/2, y - z); ctx.lineTo(x - w/2, y); ctx.lineTo(x, y + h/2); ctx.lineTo(x, y + h/2 - z); ctx.closePath();
  ctx.fillStyle=leftColor; ctx.fill();
  // windows
  ctx.fillStyle="#b8c9e6"; ctx.fillRect(x + w/2 - 6, y - z + 6, 2, 2); ctx.fillRect(x + w/2 - 6, y - z + 16, 2, 2);
  ctx.fillRect(x - w/2 + 4, y - z + 9, 2, 2); ctx.fillRect(x - w/2 + 4, y - z + 19, 2, 2);
}
function drawBusiness(b){
  const p=isoToScreen(b.col,b.row);
  drawDiamond(p.x,p.y,TILE_W,TILE_H,"#152341");
  const baseHue = ({
    "Grocery": 200, "Market": 205, "Pharmacy": 210, "Cafe": 215, "Bookstore": 220,
    "Toy Shop": 225, "Clothing": 230, "Electronics": 235, "Outlet": 240
  }[b.type] ?? 210);
  const top = hsl(baseHue, 45, 46);
  const left= hsl(baseHue, 52, 35);
  const right=hsl(baseHue, 40, 39);
  drawSideFaces(p.x,p.y,TILE_W,TILE_H,ELEV,left,right);
  drawRoofTop  (p.x,p.y,TILE_W,TILE_H,ELEV,top);
  ctx.fillStyle="#deebff"; ctx.font="11px system-ui"; ctx.textAlign="center";
  ctx.fillText(b.type.split(' ')[0], p.x, p.y - ELEV - 12);
  if(b.owner===0){ ctx.strokeStyle="#ffd66b"; ctx.lineWidth=1.5; ctx.strokeRect(p.x - TILE_W/2 + 4, p.y - ELEV - TILE_H/2 + 4, TILE_W - 8, TILE_H - 8) }
}
function drawHouse(h){
  const p=isoToScreen(h.col,h.row);
  drawDiamond(p.x,p.y,TILE_W,TILE_H,"#121d3b");
  const z = ELEV*0.7;
  const top = hsl(215, 35, 40);
  const left= hsl(215, 40, 30);
  const right=hsl(215, 36, 34);
  drawSideFaces(p.x,p.y,TILE_W,TILE_H,z,left,right);
  drawRoofTop  (p.x,p.y,TILE_W,TILE_H,z, top);
  if(h.id===player.home){ ctx.strokeStyle="#6be6ff"; ctx.lineWidth=1.2; ctx.strokeRect(p.x - TILE_W/2 + 3, p.y - z - TILE_H/2 + 3, TILE_W - 6, TILE_H - 6) }
}
function drawBlob2D(context,x,y,r,body){
  context.globalAlpha=0.35; context.beginPath(); context.ellipse(x, y+6, r*1.2, r*0.55, 0, 0, Math.PI*2); context.fillStyle="#000"; context.fill(); context.globalAlpha=1;
  const g=context.createRadialGradient(x-r*0.4,y-r*0.5, r*0.3, x,y,r);
  g.addColorStop(0, "#ffffff"); g.addColorStop(0.12, body); g.addColorStop(1, body);
  context.fillStyle=g; context.beginPath(); context.arc(x,y,r,0,Math.PI*2); context.fill();
}
function drawBlob(x,y,r,body){ drawBlob2D(ctx,x,y,r,body) }

function render(){
  ctx.clearRect(0,0,W,H);
  drawGround();
  const sorted = [...buildings].sort((a,b)=>(a.row+a.col)-(b.row+b.col));
  for(const b of sorted){ if(b.kind==='house') drawHouse(b); else drawBusiness(b); }
  for(const c of citizens){ drawBlob(c.x, c.y - 10, 6, c.sick ? "#ff6c6c" : "#65e2ff"); }
  drawBlob(player.x, player.y - 12, 8, player.sick ? "#ffb36b" : "#ffe36b");
}
function shade(hslStr, amt){
  const m = /hsl\(([\d.]+)\s+([\d.]+)%\s+([\d.]+)%\)/.exec(hslStr);
  if(!m) return hslStr; const h=+m[1], s=+m[2], l=clamp(+m[3] + amt*100, 0, 100);
  return `hsl(${h} ${s}% ${l}%)`;
}

/* =========================
   INPUT
========================= */
cvs.addEventListener('mousemove', e=>{
  const r=cvs.getBoundingClientRect(), x=e.clientX-r.left, y=e.clientY-r.top;
  const iso=screenToIso(x,y); const b=buildingAt(iso.col,iso.row);
  if(!b){ hoverEl.textContent=""; return }
  if(b.kind==='house'){ hoverEl.textContent=`${b.name} (House)`; return }
  const offers=Object.keys(b.stock).map(pid=>{
    const inv=b.stock[pid], ask=b.sellerIdeal[pid].toFixed(2);
    return `${product(pid).name}: inv ${inv}, ask ~$${ask}`;
  }).join(" · ");
  const own = b.owner===-1? "Unowned" : (b.owner===0? "Owned by You":"Owned");
  hoverEl.textContent = `${b.name} (${b.type}) — ${offers} — ${own}${b.hired?' · Worker hired':''}`;
});
cvs.addEventListener('click', e=>{
  if(phase!=='Planning') return;
  const r=cvs.getBoundingClientRect(), x=e.clientX-r.left, y=e.clientY-r.top;
  const iso=screenToIso(x,y); const b=buildingAt(iso.col,iso.row);
  if(!b || b.kind!=='biz') return;
  const slot = player.dest[0]==null?0:(player.dest[1]==null?1:-1);
  if(slot===-1){ log('Both visits selected. Use Clear Visits to change.'); return }
  player.dest[slot]=b.id; (slot? v2El:v1El).textContent=`${b.name} (${b.type})`;
  visitsLeft = visitsMax - (player.dest.filter(v=>v!=null).length); visitsLeftEl.textContent=visitsLeft;
  pane.innerHTML = renderBizPane(b, slot); bindBizPane(b, slot);
});
function buildingAt(col,row){ return buildings.find(b=>b.col===col && b.row===row) }

/* =========================
   CONTROLS
========================= */
gid('clearBtn').onclick=()=>{
  player.dest=[null,null]; v1El.textContent='— (click a business)'; v2El.textContent='— (click a business)';
  visitsLeft=visitsMax; visitsLeftEl.textContent=visitsLeft; pane.innerHTML='';
};
gid('startBtn').onclick=startDay;
gid('fastBtn').onclick=()=>{ speed=(speed===SPEEDS.fast?SPEEDS.normal:SPEEDS.fast); log(`Speed: ${speed===SPEEDS.fast?'Fast':'Normal'}`) }
gid('skipBtn').onclick=()=>{ speed=SPEEDS.skip; log('Skipping…') }
gid('expandBtn').onclick=()=>{
  const cost = 150 + (player.houseLv-1)*100;
  if(player.money < cost){ log('Not enough money to expand house.'); return }
  player.money -= cost; player.houseLv++; updateTop();
  log(`House expanded to Lv ${player.houseLv}. Infection risk slightly reduced and negotiation improved.`);
};
leaveStoreBtn.onclick=()=>closeInterior();

/* =========================
   DAY / PHASE FLOW
========================= */
function startDay(){
  if(running) return;
  refreshNeedsFromInventory();

  // Enforce the rule: one FOOD store and one FUN store
  // (unless sick & not forgetting; then home-home; if sick & "forget", still enforce)
  const foodBiz = pickAnyStoreOffering(FOOD_IDS);
  const funBiz  = pickAnyStoreOffering(FUN_IDS);

  if(player.sick && Math.random()>SICK_FORGET_PROB){
    player.dest=[player.home, player.home];
    v1El.textContent='(Sick) Stay Home'; v2El.textContent='(Sick) Stay Home';
    player.work=[false,false]; w1El.checked=false; w2El.checked=false;
  } else {
    // If the player pre-picked, we’ll correct to satisfy the rule.
    let d0 = player.dest[0], d1 = player.dest[1];
    const types = id => (id==null)?null:buildings[id].offersSet || new Set(Object.keys(buildings[id].stock));
    // helper flags
    const isFood = id => id!=null && intersects(types(id), FOOD_IDS);
    const isFun  = id => id!=null && intersects(types(id), FUN_IDS);

    // build offersSet lazily
    for(const b of buildings) if(b.kind==='biz' && !b.offersSet){
      b.offersSet = new Set(Object.keys(b.stock));
    }

    if(!isFood(d0) && !isFood(d1)) d0 = foodBiz ?? d0 ?? d1;
    if(!isFun(d0)  && !isFun(d1))  d1 = funBiz  ?? d1 ?? d0;

    // If still missing (rare), force-pick
    if(!isFood(d0) && !isFood(d1)) d0 = foodBiz ?? d0;
    if(!isFun(d0)  && !isFun(d1))  d1 = funBiz  ?? d1;

    player.dest=[d0,d1];
    v1El.textContent = buildings[d0]? `${buildings[d0].name} (${buildings[d0].type})` : '—';
    v2El.textContent = buildings[d1]? `${buildings[d1].name} (${buildings[d1].type})` : '—';
    player.work=[!!w1El.checked, !!w2El.checked];
  }

  // visits available (needs can still limit to 1; but planner sets the two categories regardless)
  visitsMax = (player.needs.foodOk && player.needs.funOk) ? 2 : 1;
  visitsLeft = Math.min(visitsMax, player.dest.filter(v=>v!=null).length);
  visitsMaxEl.textContent=visitsMax; visitsLeftEl.textContent=visitsLeft;

  // citizens plan
  for(const a of citizens){
    if(a.sick && Math.random()>SICK_FORGET_PROB){
      a.plan=[a.home, a.home];
    } else {
      const ids=buildings.filter(b=>b.kind==='biz').map(b=>b.id);
      // They’ll also try to mix food/fun if possible
      a.plan=[ pickAnyStoreOffering(FOOD_IDS, ids) ?? choice(ids),
               pickAnyStoreOffering(FUN_IDS,  ids) ?? choice(ids) ];
    }
  }

  tPhase=0; lastTs=0; speed=SPEEDS.normal; phase='Visit 1'; phaseEl.textContent=phase; running=true;
  prepPhase(0); log(`Day ${day} started. (Rule: 1 Food & 1 Fun stop)`);
}
function intersects(setA, setB){
  for(const x of setA) if(setB.has(x)) return true;
  return false;
}
function pickAnyStoreOffering(targetSet, fromIds=null){
  const candidates = buildings.filter(b=>b.kind==='biz' && intersects(new Set(Object.keys(b.stock)), targetSet));
  const pool = fromIds? candidates.filter(c=>fromIds.includes(c.id)) : candidates;
  return pool.length? choice(pool).id : null;
}

function prepPhase(k){
  player.currentPhaseIndex = k;
  aimTo(player, pointOf(player, k));
  citizens.forEach(a=>aimTo(a, pointOf(a, k)));
  closeInterior(true);
  const destId=player.dest[k]; pane.innerHTML='';
  if(destId!=null){ const b=buildings[destId]; if(b.kind==='biz'){ pane.innerHTML=renderShopPane(b,k); bindShopButtons(b,k) } }
}
function pointOf(agent,k){
  const id=(agent===player? player.dest[k] : agent.plan[k]);
  const target = (id==null) ? buildings[agent.home] : buildings[id];
  return isoToScreen(target.col,target.row);
}
function aimTo(agent, pt){
  const dx=pt.x-agent.x, dy=pt.y-agent.y, steps=(PHASE_MS/16.7);
  agent.vx=dx/steps; agent.vy=dy/steps; agent.target=pt;
}

/* =========================
   ECONOMY + OWNERSHIP
========================= */
function midPrice(buyerIdeal,sellerIdeal,edge=0){
  const p=(buyerIdeal+sellerIdeal)/2; return Math.round(p - edge*(sellerIdeal-buyerIdeal));
}
function negotiationEdge(){ let e = 0.03 + (player.houseLv-1)*0.02; if(player.needs.grumpy) e -= 0.02; return clamp(e,0,0.15) }
function bizCost(b){ let val=0; for(const pid of Object.keys(b.stock)){ val += b.stock[pid]*product(pid).base } return Math.max(120, Math.round(val*1.8)); }

function renderBizPane(b,slot){
  const own = b.owner===0;
  const buyCost=bizCost(b);
  const hireRow = own ? `<div>Worker: <strong>${b.hired?'Hired':'None'}</strong> <button id="hireBtn">${b.hired?'Fire (no cost)':'Hire ($20/day)'}</button></div>` : '';
  return `
  <div class="slot">
    <div><strong>${b.name}</strong> — ${b.owner===-1?'Unowned':(own?'Owned by You':'Owned')}</div>
    ${!own && b.owner===-1 ? `<button id="buyBtn">Buy ($${buyCost})</button>` : ''}
    ${hireRow}
    <div style="margin-top:6px"><em>Stock (choose a seller inside):</em></div>
    <ul style="list-style:none;padding-left:14px;text-align:left">
      ${Object.keys(b.stock).map(pid=>{
        const p=product(pid), inv=b.stock[pid], ask=b.sellerIdeal[pid];
        return `<li>${p.name}: inv <strong>${inv}</strong> · baseline ask ~$${ask.toFixed(2)}</li>`
      }).join('') || '<li>Sold out.</li>'}
    <div style="margin-top:6px"><button id="enterBtn">Enter store</button></div>
  </div>`;
}
function bindBizPane(b,slot){
  const buy=gid('buyBtn'); if(buy){ buy.onclick=()=>{ const cost=bizCost(b); if(player.money<cost){log('Not enough money.');return} player.money-=cost; b.owner=0; updateTop(); log(`You bought ${b.name}.`); pane.innerHTML=renderBizPane(b,slot); bindBizPane(b,slot)} }
  const hire=gid('hireBtn'); if(hire){ hire.onclick=()=>{ b.hired=!b.hired; log(`${b.hired?'Hired':'Fired'} worker at ${b.name}.`); pane.innerHTML=renderBizPane(b,slot); bindBizPane(b,slot)} }
  const enter=gid('enterBtn'); if(enter){ enter.onclick=()=>openInterior(b) }
}

/* =========================
   STORE INTERIOR (with personalities)
========================= */
function sellerAskFor(shop, seller, pid){
  let ask = shop.sellerIdeal[pid] ?? product(pid).base*1.3;
  const per = seller.persona||{};
  // base multiplier
  ask *= (per.askMul ?? 1);
  // low/high stock effects
  const stock = shop.stock[pid] ?? 0;
  if(stock <= 2 && per.lowStockMarkup) ask *= (1 + per.lowStockMarkup);
  if(stock >= 10 && per.bulkDiscount)   ask *= (1 - per.bulkDiscount);
  // jitter
  if(per.jitter) ask *= (1 + rand(-per.jitter, per.jitter));
  return +ask.toFixed(2);
}
function openInterior(b){
  interiorName.textContent = `${b.name} (${b.type})`;
  interiorWrap.style.display = "flex";
  player.inStore = b.id;
  drawInterior(b);
  buildSellerCards(b);
}
function closeInterior(silent=false){
  interiorWrap.style.display = "none";
  if(!silent && player.inStore!=null) log(`You left ${buildings[player.inStore].name}.`);
  player.inStore = null;
}
function drawInterior(b){
  ictx.clearRect(0,0,interiorCanvas.width, interiorCanvas.height);
  ictx.fillStyle="#101b35"; ictx.fillRect(0,0,interiorCanvas.width,interiorCanvas.height);
  for(let i=1;i<=3;i++){ ictx.fillStyle = i%2? "#0f1428":"#0e152a"; ictx.fillRect(40, 40 + i*80, interiorCanvas.width-80, 50); }
  const sellers = b.sellers;
  const spacing = (interiorCanvas.width-120)/sellers.length;
  sellers.forEach((s,idx)=>{
    const cx = 80 + idx*spacing + spacing/2, cy = 120;
    ictx.fillStyle="#1b2546"; ictx.fillRect(cx-50, cy+18, 100, 16);
    drawBlob2D(ictx, cx, cy, 12, s.persona?.color || "#7ec3ff");
    ictx.fillStyle="#d7e6ff"; ictx.font="12px system-ui"; ictx.textAlign="center";
    ictx.fillText(`${s.name}`, cx, cy-18);
  });
}
function buildSellerCards(b){
  sellerList.innerHTML="";
  const sellers = b.sellers;
  sellers.forEach((s,idx)=>{
    const div=document.createElement('div'); div.className='sellerCard';
    const items = (s.offers||[]).map(pid=>{
      const p=product(pid);
      const ask = sellerAskFor(b, s, pid);
      const you=player.priceIdeal[pid] ?? p.base;
      // personality edge modifies your normal edge a bit
      let edge = negotiationEdge() + (s.persona?.edgeBonus || 0);
      edge = clamp(edge, 0, 0.2);
      const price = midPrice(you, ask, edge);
      const inv = b.stock[pid] ?? 0;
      return `<li>${p.name}: inv <strong>${inv}</strong>
              · seller $${ask.toFixed(2)} · you $${you.toFixed(2)}
              → <strong>$${price}</strong>
              <button data-buy="${pid}" data-sidx="${idx}" ${inv<=0?'disabled':''}>Buy</button></li>`;
    }).join("") || "<li>Nothing to sell.</li>";

    const badgeStyle = `background:${(s.persona?.color||'#2b3e6a')}22; border-color:${s.persona?.color||'#2b3e6a'}; color:#e7f2ff`;
    div.innerHTML = `
      <h4>${s.name}
        <span class="badge" style="${badgeStyle}" title="${s.persona?.desc||''}">
          ${s.persona?.title||'Seller'}
        </span>
      </h4>
      <div class="mini">${s.persona?.desc||''}</div>
      <ul style="list-style:none; padding-left:14px">${items}</ul>
    `;
    sellerList.appendChild(div);
  });
  // bind
  sellerList.querySelectorAll('button[data-buy]').forEach(btn=>{
    btn.onclick=()=>{
      const pid=btn.getAttribute('data-buy');
      const sidx=+btn.getAttribute('data-sidx');
      const shop=buildings[player.inStore]; const seller=shop.sellers[sidx];
      if((shop.stock[pid]||0)<=0){ log('Out of stock.'); buildSellerCards(shop); return }
      const p=product(pid), you=player.priceIdeal[pid] ?? p.base;
      const ask=sellerAskFor(shop, seller, pid);
      let edge = negotiationEdge() + (seller.persona?.edgeBonus || 0);
      edge = clamp(edge, 0, 0.2);
      const price=midPrice(you,ask,edge);
      if(player.money<price){ log(`Not enough money for ${p.name} ($${price}).`); return }
      // transact
      player.money-=price; player.inventory[pid]=(player.inventory[pid]||0)+1; shop.stock[pid]--; shop.till+=price;
      if(player.currentPhaseIndex!=null && player.work[player.currentPhaseIndex]){ player.money+=price }
      if((shop.stock[pid]||0)<=1) shop.sellerIdeal[pid]*=1.02;
      refreshNeedsFromInventory(); updateTop(); buildSellerCards(shop); drawInterior(shop);
      log(`You bought ${p.name} from ${seller.name} (${seller.persona?.title||'Seller'}) @ ${shop.name} for $${price}.`);
    };
  });
}

/* =========================
   NEEDS
========================= */
function hasFood(){ return (player.inventory.food||0) > 0 }
function hasFun(){ return (player.inventory.book||0)>0 || (player.inventory.toy||0)>0 || (player.inventory.coffee||0)>0 }
function refreshNeedsFromInventory(){
  player.needs.foodOk = hasFood();
  player.needs.funOk  = hasFun();
  player.needs.grumpy = !(player.needs.foodOk && player.needs.funOk);
  nfEl.className = player.needs.foodOk ? 'ok' : 'bad';
  neEl.className = player.needs.funOk  ? 'ok' : 'bad';
  nfEl.textContent = player.needs.foodOk ? 'OK' : 'NEEDED';
  neEl.textContent = player.needs.funOk  ? 'OK' : 'NEEDED';
}
function consumeNeeds(){
  if((player.inventory.food||0)>0){ player.inventory.food--; }
  if((player.inventory.book||0)>0){ player.inventory.book--; }
  else if((player.inventory.toy||0)>0){ player.inventory.toy--; }
  else if((player.inventory.coffee||0)>0){ player.inventory.coffee--; }
}

/* =========================
   INFECTION & SIM
========================= */
function infectionMultiplier(){ return Math.max(0.5, 1 - 0.08*(player.houseLv-1)) }

function step(ts){
  if(!running){ render(); requestAnimationFrame(step); return }
  if(!lastTs) lastTs=ts;
  let dt=(ts-lastTs)/1000; lastTs=ts; dt*=speed;

  moveAgent(player,dt);
  citizens.forEach(a=>moveAgent(a,dt));

  // proximity infection
  infCheck(player, citizens, dt);
  citizens.forEach(c=>infCheck(c, [player,...citizens], dt));

  // commerce each phase
  const k = (phase==='Visit 1'?0:(phase==='Visit 2'?1:null));
  if(k!=null){
    simulateWorkerSales(k);
    citizens.forEach(a=>maybeBuyWhenArrive(a,k,false));
    handlePlayerArrivalForInterior(k);
  }

  tPhase += dt*1000;
  if((phase==='Visit 1' || phase==='Visit 2') && (tPhase>=PHASE_MS || speed===SPEEDS.skip)){
    relaxPricesSlightly();
    if(phase==='Visit 1' && visitsMax===2){ phase='Visit 2'; phaseEl.textContent=phase; tPhase=0; prepPhase(1); }
    else { startReturnHome(); }
    if(speed===SPEEDS.skip) speed=SPEEDS.normal;
  } else if(phase==='Returning' && (tPhase>=RETURN_MS || speed===SPEEDS.skip)){
    finishDay();
    if(speed===SPEEDS.skip) speed=SPEEDS.normal;
  }

  render(); requestAnimationFrame(step);
}
function moveAgent(a,dt){ if(!a.target) return; a.x += a.vx*(dt*60); a.y += a.vy*(dt*60); }
function handlePlayerArrivalForInterior(k){
  const destId = player.dest[k]; if(destId==null) return;
  const b = buildings[destId]; const target=isoToScreen(b.col,b.row);
  const arrived = ((player.x-target.x)**2 + (player.y-target.y)**2) < 25;
  if(arrived && player.inStore==null){ openInterior(b); }
}
function relaxPricesSlightly(){
  for(const b of buildings) if(b.kind==='biz'){
    for(const pid of Object.keys(b.stock)) if(b.stock[pid]>8) b.sellerIdeal[pid]*=0.99;
  }
}
function startReturnHome(){
  phase='Returning'; phaseEl.textContent=phase; tPhase=0;
  const homeP=buildings[player.home]; aimTo(player, isoToScreen(homeP.col, homeP.row));
  citizens.forEach(a=>{ const hm=buildings[a.home]; aimTo(a, isoToScreen(hm.col, hm.row)); });
  closeInterior(true);
}
function finishDay(){
  consumeNeeds();
  if(player.sick){ player.sickDays--; if(player.sickDays<=0){ player.sick=false; statusEl.textContent='Healthy'; statusEl.className='accent ok'; log('You recovered!') } else { statusEl.textContent=`Sick (${player.sickDays}d)` } }
  const wages = buildings.filter(b=>b.kind==='biz' && b.owner===0 && b.hired).length * 20;
  if(wages>0){ player.money -= wages; updateTop(); log(`Paid worker wages: $${wages}.`) }
  day++; dayEl.textContent=day; phase='Planning'; phaseEl.textContent=phase; running=false;
  citizens.forEach(a=>{ a.didBuy=false });
  player.dest=[null,null]; v1El.textContent='— (click a business)'; v2El.textContent='— (click a business)';
  refreshNeedsFromInventory();
  visitsMax = (player.needs.foodOk && player.needs.funOk)? 2 : 1;
  visitsLeft=visitsMax; visitsMaxEl.textContent=visitsMax; visitsLeftEl.textContent=visitsLeft;
  for(const b of buildings) if(b.kind==='biz'){
    for(const pid of Object.keys(b.stock)){ if(b.stock[pid]<8) b.stock[pid]+=rint(0,2) }
    for(const pid of Object.keys(b.sellerIdeal)){ b.sellerIdeal[pid]*=rand(0.98,1.02) }
  }
  log(`Day ${day-1} ended. Everyone returned home.`);
}

function infCheck(a, others, dt){
  if(a.sick) return;
  const baseRate = (a===player? INF_BASE*infectionMultiplier(): INF_BASE);
  const prob = 1 - Math.pow(1 - baseRate, dt);
  for(const o of others){
    if(!o.sick) continue;
    const dx=a.x-o.x, dy=a.y-o.y, d2=dx*dx+dy*dy;
    if(d2 <= INF_RAD*INF_RAD){
      if(Math.random()<prob){
        a.sick=true; a.sickDays=SICK_DAYS;
        if(a===player){ statusEl.textContent=`Sick (${a.sickDays}d)`; statusEl.className='accent bad'; log('You became sick.') }
      }
      break;
    }
  }
}
function maybeBuyWhenArrive(agent,k,playerWorking){
  const id=(agent===player? player.dest[k] : agent.plan[k]); if(id==null) return;
  const b=buildings[id]; if(!b || b.kind!=='biz') return;
  const target=isoToScreen(b.col,b.row);
  const arrived = ((agent.x-target.x)**2 + (agent.y-target.y)**2) < 25;
  if(!arrived) return;
  if(agent!==player){
    if(!agent.didBuy && Math.random()<0.45){
      trySaleAtShop(b, agent, false); agent.didBuy=true;
    }
  }
}
function simulateWorkerSales(k){
  const phaseShops = buildings.filter(b=>b.kind==='biz' && b.owner===0 && b.hired);
  for(const shop of phaseShops){
    const attempts = rint(1,3);
    for(let i=0;i<attempts;i++){
      const cust = {wallet:rint(30,140), priceIdeal:{}};
      for(const pr of PRODUCTS){ cust.priceIdeal[pr.id]=pr.base*rand(0.85,1.15) }
      const pick = Object.keys(shop.stock).filter(pid=>shop.stock[pid]>0);
      if(pick.length===0) break;
      pick.sort((a,b)=> (cust.priceIdeal[a]||999)-(cust.priceIdeal[b]||999));
      const pid=pick[0], p=product(pid);
      const price = Math.round((cust.priceIdeal[pid] + shop.sellerIdeal[pid])/2);
      if(cust.wallet < price) continue;
      shop.stock[pid]--; shop.till+=price;
      const cut = Math.floor(price*0.5);
      player.money += cut; updateTop();
      log(`Worker sold ${p.name} @ ${shop.name} for $${price}. You earned $${cut} (owner cut).`);
      if(shop.stock[pid]<=1) shop.sellerIdeal[pid]*=1.02;
    }
  }
}
function trySaleAtShop(shop, buyer, playerWorking){
  const options=Object.keys(shop.stock).filter(pid=>shop.stock[pid]>0);
  if(options.length===0) return false;
  options.sort((a,b)=> (buyer.priceIdeal[a]||9999)-(buyer.priceIdeal[b]||9999));
  const pid=options[0], p=product(pid);
  const buyerIdeal=buyer.priceIdeal[pid] ?? p.base;
  const sellerIdeal=shop.sellerIdeal[pid] ?? p.base*1.3;
  const price=midPrice(buyerIdeal, sellerIdeal, buyer===player?negotiationEdge():0);
  const hasMoney = (buyer===player? player.money : buyer.wallet) >= price;
  if(!hasMoney) return false;

  if(buyer===player){
    player.money -= price; player.inventory[pid]=(player.inventory[pid]||0)+1; refreshNeedsFromInventory(); updateTop();
  }else{
    buyer.wallet -= price;
  }
  shop.stock[pid]--; shop.till+=price;
  if(playerWorking) { player.money += price; updateTop() }
  if(shop.stock[pid]<=1) shop.sellerIdeal[pid]*=1.02;
  log(`${buyer===player?'You':'A customer'} bought ${p.name} @ ${shop.name} for $${price}.`);
  return true;
}

/* =========================
   MISC
========================= */
function updateTop(){ moneyEl.textContent=Math.floor(player.money); houseLvEl.textContent=player.houseLv }
function renderShopPane(b, slot){ return renderBizPane(b, slot) }
function bindShopButtons(b, slot){ bindBizPane(b, slot) }

/* =========================
   LOOP
========================= */
requestAnimationFrame(step);
render();
refreshNeedsFromInventory();
</script>
</body>
</html>
